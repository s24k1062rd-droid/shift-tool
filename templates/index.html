<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            padding-bottom: 60px;
        }

        .header {
            background-color: #2196F3;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            margin: 0;
            flex: 1;
            text-align: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .role-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            background-color: white;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: white;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid #2196F3;
            color: #2196F3;
            font-weight: bold;
        }

        .content {
            display: none;
            padding: 15px;
        }

        .content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .staff-list {
            list-style: none;
        }

        .staff-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .staff-item:last-child {
            border-bottom: none;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-nav button {
            padding: 8px 15px;
            border: 1px solid #2196F3;
            background: white;
            color: #2196F3;
            border-radius: 4px;
            cursor: pointer;
        }

        .month-nav h3 {
            font-size: 18px;
        }

        .shift-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }

        th {
            background-color: #2196F3;
            color: white;
            position: sticky;
            top: 0;
        }

        td.staff-name {
            font-weight: 500;
            background-color: #f9f9f9;
            text-align: left;
            position: sticky;
            left: 0;
        }

        td.clickable {
            cursor: pointer;
            min-width: 60px;
        }

        td.clickable:hover {
            background-color: #e3f2fd;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h3 {
            margin-bottom: 15px;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-group label {
            display: block;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .checkbox-group label:has(input:checked) {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }
        
        .change-option {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            border: 1px solid #ffc107;
        }
        
        .change-option h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #856404;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .shift-result {
            max-height: 60vh;
            overflow-y: auto;
        }

        .date-group {
            margin-bottom: 20px;
        }

        .date-group h3 {
            background-color: #2196F3;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .shift-item {
            padding: 8px;
            border-left: 3px solid #4CAF50;
            background-color: #f9f9f9;
            margin-bottom: 5px;
            padding-left: 10px;
        }

        .requirement-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            padding-left: 10px;
        }

        .requirement-item.satisfied {
            background-color: #d4edda;
            border-left-color: #28a745;
        }

        .requirement-item.unsatisfied {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

        .time-slot-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: #1976d2;
        }

        .time-slot-tag .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .time-slot-tag .remove-btn:hover {
            background: #d32f2f;
        }

        @media (max-width: 600px) {
            .tabs {
                font-size: 12px;
            }
            
            .tab {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“… ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</h1>
        <div class="header-right">
            <span class="role-badge" id="storeBadge">åº—èˆ—: èª­è¾¼ä¸­</span>
            <span class="role-badge" id="roleBadge">ç®¡ç†è€…</span>
            <button class="logout-btn" onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('staff', event)">ã‚¹ã‚¿ãƒƒãƒ•</button>
        <button class="tab" onclick="showTab('shifts', event)">ã‚·ãƒ•ãƒˆå¸Œæœ›</button>
        <button class="tab" onclick="showTab('generate', event)">ã‚·ãƒ•ãƒˆè¡¨</button>
        <button class="tab" onclick="showTab('settings', event)">è©³ç´°è¨­å®š</button>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã‚¿ãƒ– -->
    <div id="staff" class="content active">
        <div class="card">
            <h2>ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h2>
            <div class="form-group">
                <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                <input type="text" id="staffName" placeholder="åå‰ã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label>ç¨®åˆ¥</label>
                <select id="staffType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                    <option value="ã‚¢ãƒ«ãƒã‚¤ãƒˆ">ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
                    <option value="ç¤¾å“¡">ç¤¾å“¡</option>
                    <option value="ãã®ä»–">ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰</option>
                </select>
            </div>
            <div class="form-group" id="staffTypeOtherGroup" style="display: none;">
                <label>ç¨®åˆ¥ï¼ˆãã®ä»–ï¼‰</label>
                <input type="text" id="staffTypeOther" placeholder="ä¾‹ï¼šãƒ‘ãƒ¼ãƒˆ">
            </div>
            <div class="form-group">
                <label>å„ªå…ˆé †ä½ï¼ˆä»»æ„ï¼‰</label>
                <input type="number" id="staffPriority" placeholder="ä¾‹ï¼š1ï¼ˆå°ã•ã„ã»ã©å„ªå…ˆï¼‰" min="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                <p style="font-size: 11px; color: #666; margin-top: 5px;">â€»æ•°å€¤ãŒå°ã•ã„ã»ã©å„ªå…ˆé †ä½ãŒé«˜ããªã‚Šã¾ã™ã€‚ç©ºæ¬„ã®å ´åˆã¯æœ€ä½å„ªå…ˆåº¦ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚</p>
            </div>
            <button type="button" class="btn btn-primary" id="addStaffBtn">è¿½åŠ </button>
        </div>

        <div class="card">
            <h2>ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•</h2>
            <ul class="staff-list" id="staffList"></ul>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›ã‚¿ãƒ– -->
    <div id="shifts" class="content">
        <div class="card">
            <div class="month-nav">
                <button onclick="changeMonth(-1, 'shifts')">â—€ å‰æœˆ</button>
                <h3 id="shiftMonth"></h3>
                <button onclick="changeMonth(1, 'shifts')">æ¬¡æœˆ â–¶</button>
            </div>
            <div class="shift-table">
                <table id="shiftTable"></table>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆã‚¿ãƒ– -->
    <div id="generate" class="content">
        <div class="card">
            <h2>ã‚·ãƒ•ãƒˆç”Ÿæˆ</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                â€»ã‚·ãƒ•ãƒˆã¯è‡ªå‹•çš„ã«æœ€é©åŒ–ã•ã‚Œã¾ã™ã€‚å¿…è¦äººæ•°ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã€é©æ­£äººæ•°ã¾ã§èª¿æ•´ã•ã‚Œã¾ã™ã€‚
            </p>
            <button class="btn btn-success" onclick="generateShift()">ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆ</button>
            <button class="btn btn-primary" onclick="exportCSV()" style="margin-top: 10px;">PDFå‡ºåŠ›</button>
        </div>
        <div class="card">
            <h2>ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ•ãƒˆ</h2>
            <div class="shift-result" id="shiftResult"></div>
        </div>
    </div>

    <!-- è©³ç´°è¨­å®šã‚¿ãƒ– -->
    <div id="settings" class="content">
        <div class="card">
            <h2>ğŸ• æ™‚é–“å¸¯ç®¡ç†</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                ã‚·ãƒ•ãƒˆã§ä½¿ç”¨ã™ã‚‹æ™‚é–“å¸¯ã‚’ç®¡ç†ã—ã¾ã™ã€‚æ™‚é–“å¸¯ã‚’è¿½åŠ ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚
            </p>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; font-size: 16px;">ç¾åœ¨ã®æ™‚é–“å¸¯</h3>
                <p style="font-size: 11px; color: #999; margin-bottom: 8px;">â€»ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã§ãã¾ã™</p>
                <div id="timeSlotsList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="text" id="newTimeSlot" placeholder="ä¾‹ï¼š14-18 ã¾ãŸã¯ æƒé™¤" 
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <button class="btn btn-primary" onclick="addTimeSlot()">â• æ™‚é–“å¸¯ã‚’è¿½åŠ </button>
                </div>
                <p style="font-size: 11px; color: #999; margin-top: 5px;">
                    â€» æ™‚é–“å½¢å¼: ã€Œé–‹å§‹-çµ‚äº†ã€ï¼ˆä¾‹ï¼š10-15, 17:30-23:00, 17:30-29:00ï¼‰<br>
                    â€» ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼: æ—¥æœ¬èªã€è‹±å­—ãªã©è‡ªç”±ã«å…¥åŠ›ï¼ˆä¾‹ï¼šæƒé™¤, å–¶æ¥­æº–å‚™, cleaningï¼‰
                </p>
            </div>
        </div>

        <div class="card">
            <h2>âš™ï¸ ã‚·ãƒ•ãƒˆè©³ç´°è¨­å®š</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                æ™‚é–“å¸¯ã”ã¨ã®å¿…è¦äººæ•°ã‚’è¨­å®šã§ãã¾ã™ã€‚ã‚·ãƒ•ãƒˆç”Ÿæˆæ™‚ã«ã“ã®è¨­å®šãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
            </p>

            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #2196F3;">ğŸ“… å¹³æ—¥ï¼ˆæ—¥ã€œæœ¨ï¼‰</h3>
            <div class="settings-table">
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr id="weekdaySettingsHead" style="background: #f5f5f5;"></tr>
                    </thead>
                    <tbody id="weekdaySettings">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #2196F3;">ğŸ‰ é€±æœ«ï¼ˆé‡‘ãƒ»åœŸï¼‰</h3>
            <div class="settings-table">
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr id="weekendSettingsHead" style="background: #f5f5f5;"></tr>
                    </thead>
                    <tbody id="weekendSettings">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <button class="btn btn-primary" onclick="saveShiftSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            <button class="btn" onclick="resetShiftSettings()" style="margin-left: 10px;">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
        </div>

        <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card">
            <h2>ğŸ” ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                ã“ã®åº—èˆ—ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚å¤‰æ›´å¾Œã¯æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </p>

            <div class="form-group">
                <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="currentPassword" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="off"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="newPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆ4æ–‡å­—ä»¥ä¸Šï¼‰" autocomplete="off"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                <input type="password" id="confirmPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›" autocomplete="off"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <button class="btn btn-primary" onclick="changePassword()">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›ï¼‰ -->
    <div id="shiftModal" class="modal">
        <div class="modal-content">
            <h3>ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</h3>
            <p id="modalInfo"></p>
            <div class="checkbox-group" id="timeSlotCheckboxes"></div>
            <div class="form-group" id="customTimeSlotGroup" style="display: none;">
                <label>æ™‚é–“å¸¯ã‚’è‡ªç”±å…¥åŠ›</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="customTimeSlotInput" placeholder="ä¾‹ï¼š12-18" style="flex: 1;">
                    <button class="btn btn-primary" type="button" style="width: auto; padding: 8px 12px;" onclick="addCustomTimeSlot()">è¿½åŠ </button>
                </div>
                <p style="font-size: 11px; color: #666; margin-top: 5px;">â€»ç®¡ç†è€…è¨­å®šå¤–ã®æ™‚é–“ã‚‚è¿½åŠ ã§ãã¾ã™</p>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveShift()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let currentStaff = [];
        let timeSlots = [];
        let changeMap = {};  // æ™‚é–“å¸¯å¤‰æ›´ãƒãƒƒãƒ—
        let modalData = {};
        let userRole = 'user';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
        });

        // UIåˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ãƒ«åˆ¥ï¼‰
        function initializeUI() {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ã¾ãŸã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ï¼‰
            // ç°¡æ˜“çš„ã«ã¯ã€ãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹ã‚’ç¢ºèª
            fetch('/api/check-auth')
                .then(response => {
                    if (response.status === 401) {
                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.role) {
                        userRole = data.role;
                        // åº—èˆ—æƒ…å ±ã‚’è¡¨ç¤º
                        const storeBadge = document.getElementById('storeBadge');
                        if (data.store_code) {
                            storeBadge.textContent = `ğŸª ${data.store_code}`;
                        }
                        applyRoleBasedUI(data.role);
                    }
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    window.location.href = '/login';
                });
            
            // ã“ã“ã‹ã‚‰ã€ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã®åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰
            console.log('DOM loaded, initializing...');
            loadStaff();
            
            // ãƒœã‚¿ãƒ³ã®å‹•ä½œç¢ºèª
            const staffNameInput = document.getElementById('staffName');
            const staffTypeSelect = document.getElementById('staffType');
            const addStaffBtn = document.getElementById('addStaffBtn');
            
            if (staffNameInput) {
                console.log('staffName input found');
            } else {
                console.error('staffName input NOT found');
            }
            if (staffTypeSelect) {
                console.log('staffType select found');
                staffTypeSelect.addEventListener('change', toggleStaffTypeOther);
                toggleStaffTypeOther();
            } else {
                console.error('staffType select NOT found');
            }
            if (addStaffBtn) {
                console.log('addStaffBtn button found');
                
                // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ç¢ºèªã—ã¦å‰Šé™¤ï¼ˆé‡è¤‡ç™»éŒ²é˜²æ­¢ï¼‰
                const newBtn = addStaffBtn.cloneNode(true);
                addStaffBtn.parentNode.replaceChild(newBtn, addStaffBtn);
                const freshBtn = document.getElementById('addStaffBtn');
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ï¼ˆã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãŸã‚é‡è¤‡ã¯ãªã„ï¼‰
                freshBtn.addEventListener('click', function(e) {
                    console.log('Button clicked via event listener');
                    e.preventDefault();
                    addStaff();
                });
            } else {
                console.error('addStaffBtn button NOT found');
            }
            
            // Enterã‚­ãƒ¼ã§ã‚‚è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            if (staffNameInput) {
                staffNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('Enter key pressed');
                        e.preventDefault();
                        addStaff();
                    }
                });
            }
            
            // æ™‚é–“å¸¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®Enterã‚­ãƒ¼å¯¾å¿œ
            const newTimeSlotInput = document.getElementById('newTimeSlot');
            if (newTimeSlotInput) {
                newTimeSlotInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTimeSlot();
                    }
                });
            }
        }

        // ãƒ­ãƒ¼ãƒ«åˆ¥UIé©ç”¨
        function applyRoleBasedUI(role) {
            const roleBadge = document.getElementById('roleBadge');
            const tabs = document.querySelectorAll('.tab');
            
            if (role === 'admin') {
                roleBadge.textContent = 'ğŸ‘” ç®¡ç†è€…';
                // ç®¡ç†è€…ç”¨ã‚¿ãƒ–ã‚’ã™ã¹ã¦è¡¨ç¤º
                tabs.forEach(tab => tab.style.display = 'block');
                // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
                if (tabs.length > 0) {
                    setTimeout(() => showTab('staff', {target: tabs[0]}), 100);
                }
            } else {
                roleBadge.textContent = 'ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•';
                // ã‚¹ã‚¿ãƒƒãƒ•ç”¨ã‚¿ãƒ–ã®ã¿è¡¨ç¤ºï¼ˆã€Œã‚·ãƒ•ãƒˆå¸Œæœ›ã€ã®ã¿ï¼‰
                tabs.forEach((tab, index) => {
                    if (tab.textContent.includes('ã‚·ãƒ•ãƒˆå¸Œæœ›')) {
                        tab.style.display = 'block';
                    } else {
                        tab.style.display = 'none';
                    }
                });
                // ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚¿ãƒ–ã‚’æœ€åˆã«è¡¨ç¤º
                setTimeout(() => {
                    const shiftsTab = Array.from(tabs).find(t => t.textContent.includes('ã‚·ãƒ•ãƒˆå¸Œæœ›'));
                    if (shiftsTab) {
                        showTab('shifts', {target: shiftsTab});
                    }
                }, 100);
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await fetch('/api/logout', {method: 'POST'});
                    window.location.href = '/login';
                } catch (error) {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'staff') {
                loadStaff();
            } else if (tabName === 'shifts') {
                loadShiftTable();
            } else if (tabName === 'settings') {
                loadShiftSettings();
            }
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
        async function loadStaff() {
            try {
                const response = await fetch('/api/staff');
                const staffData = await response.json();
                currentStaff = staffData;
                
                const list = document.getElementById('staffList');
                list.innerHTML = '';
                
                if (Object.keys(currentStaff).length === 0) {
                    list.innerHTML = '<li class="staff-item">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</li>';
                    return;
                }
            
                Object.entries(currentStaff).sort().forEach(([name, info]) => {
                    const li = document.createElement('li');
                    li.className = 'staff-item';
                    const badge = info.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤';
                    const priorityText = info.priority !== undefined && info.priority !== null ? ` [å„ªå…ˆåº¦: ${info.priority}]` : '';
                    li.innerHTML = `
                        <span>${badge} ${name} (${info.type})${priorityText}</span>
                        <button class="btn btn-danger" style="width: auto; padding: 8px 15px;" onclick="deleteStaff('${name}')">å‰Šé™¤</button>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Error in loadStaff:', error);
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function toggleStaffTypeOther() {
            const staffTypeSelect = document.getElementById('staffType');
            const otherGroup = document.getElementById('staffTypeOtherGroup');
            if (!staffTypeSelect || !otherGroup) return;

            const isOther = staffTypeSelect.value === 'ãã®ä»–';
            otherGroup.style.display = isOther ? 'block' : 'none';

            if (!isOther) {
                const otherInput = document.getElementById('staffTypeOther');
                if (otherInput) otherInput.value = '';
            }
        }

        let addStaffCallCount = 0;  // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šaddStaffå‘¼ã³å‡ºã—å›æ•°
        let isAddingStaff = false;  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ãƒ•ãƒ©ã‚°

        async function addStaff() {
            // æ—¢ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ãªã‚‰å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (isAddingStaff) {
                console.warn('âš ï¸ Already processing a staff addition request. Skipping duplicate request.');
                return;
            }

            addStaffCallCount++;
            console.log(`[Call #${addStaffCallCount}] addStaff function called`);
            try {
                console.log('addStaff function called');
                const name = document.getElementById('staffName').value.trim();
                const typeSelect = document.getElementById('staffType');
                let type = typeSelect ? typeSelect.value : 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';

                if (type === 'ãã®ä»–') {
                    const otherInput = document.getElementById('staffTypeOther');
                    const customType = otherInput ? otherInput.value.trim() : '';
                    if (!customType) {
                        alert('ç¨®åˆ¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return;
                    }
                    type = customType;
                }
                
                const priorityInput = document.getElementById('staffPriority');
                const priority = priorityInput && priorityInput.value ? parseInt(priorityInput.value, 10) : null;
                
                console.log('Name:', name, 'Type:', type, 'Priority:', priority);
                
                if (!name) {
                    alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const body = {name, type};
                if (priority !== null) {
                    body.priority = priority;
                }

                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                isAddingStaff = true;
                const addStaffBtn = document.getElementById('addStaffBtn');
                if (addStaffBtn) {
                    addStaffBtn.disabled = true;
                    addStaffBtn.style.opacity = '0.6';
                }

                console.log(`[Call #${addStaffCallCount}] Sending POST request:`, body);
                const response = await fetch('/api/staff', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                const result = await response.json();
                console.log(`[Call #${addStaffCallCount}] Response:`, result);
                
                if (response.ok) {
                    console.log(`[Call #${addStaffCallCount}] âœ… SUCCESS`);
                    document.getElementById('staffName').value = '';
                    if (typeSelect) {
                        typeSelect.value = 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';
                    }
                    if (priorityInput) {
                        priorityInput.value = '';
                    }
                    toggleStaffTypeOther();
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®åŒæœŸã‚’å¾…ã¤ãŸã‚ã€å°‘ã—é…å»¶ã•ã›ã‚‹
                    setTimeout(() => {
                        console.log(`[Call #${addStaffCallCount}] Calling loadStaff after 500ms delay`);
                        loadStaff();
                    }, 500);
                } else {
                    console.log(`[Call #${addStaffCallCount}] âŒ ERROR: ${result.error}`);
                    alert(result.error);
                }
            } catch (error) {
                console.error(`[Call #${addStaffCallCount}] Exception in addStaff:`, error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
                isAddingStaff = false;
                const addStaffBtn = document.getElementById('addStaffBtn');
                if (addStaffBtn) {
                    addStaffBtn.disabled = false;
                    addStaffBtn.style.opacity = '1';
                }
            }
        }

        async function deleteStaff(name) {
            try {
                if (!confirm(`${name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

                const response = await fetch(`/api/staff/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadStaff();
                } else {
                    const result = await response.json();
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Error in deleteStaff:', error);
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›
        async function loadShiftTable() {
            const response = await fetch(`/api/shifts/${currentYear}/${currentMonth}`);
            const data = await response.json();
            
            currentStaff = data.staff;
            timeSlots = data.time_slots;
            
            document.getElementById('shiftMonth').textContent = `${currentYear}å¹´${currentMonth}æœˆ`;
            
            const table = document.getElementById('shiftTable');
            table.innerHTML = '';
            
            if (Object.keys(currentStaff).length === 0) {
                table.innerHTML = '<tr><td colspan="100%">ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</td></tr>';
                return;
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            let headerRow = '<tr><th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            for (let day = 1; day <= data.days_in_month; day++) {
                const dayOfWeek = new Date(currentYear, currentMonth - 1, day).getDay();
                const weekday = weekdays[dayOfWeek];
                headerRow += `<th>${day}æ—¥<br>(${weekday})</th>`;
            }
            headerRow += '</tr>';
            table.innerHTML = headerRow;
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            Object.entries(currentStaff).sort().forEach(([staffName, staffInfo]) => {
                const badge = staffInfo.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤';
                let row = `<tr><td class="staff-name">${badge} ${staffName}</td>`;
                for (let day = 1; day <= data.days_in_month; day++) {
                    const date = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const slots = data.shifts[date]?.[staffName] || [];
                    const customSlots = data.custom_shifts?.[date]?.[staffName] || [];
                    const display = [...slots, ...customSlots].join(', ');
                    
                    row += `<td class="clickable" onclick="openShiftModal('${date}', '${staffName}')">${display}</td>`;
                }
                row += '</tr>';
                table.innerHTML += row;
            });
        }

        function openShiftModal(date, staff) {
            modalData = {date, staff};
            
            document.getElementById('modalInfo').textContent = `${date} - ${staff}`;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            const container = document.getElementById('timeSlotCheckboxes');
            container.innerHTML = '';
            const customGroup = document.getElementById('customTimeSlotGroup');
            if (customGroup) {
                customGroup.style.display = 'none';
            }
            
            // ç¾åœ¨ã®é¸æŠã‚’å–å¾—
            fetch(`/api/shifts/${currentYear}/${currentMonth}`)
                .then(res => res.json())
                .then(data => {
                    const currentSelectedSlots = data.shifts[date]?.[staff] || [];
                    const currentCustomSlots = [
                        ...(data.custom_shifts?.[date]?.[staff] || []),
                        ...currentSelectedSlots.filter(slot => !timeSlots.includes(slot))
                    ].filter((slot, index, array) => array.indexOf(slot) === index);
                    const currentSlots = [...currentSelectedSlots, ...currentCustomSlots];
                    changeMap = data.change_map || {};
                    
                    // ã‚¹ã‚¿ãƒƒãƒ•ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
                    const staffType = currentStaff[staff]?.type || 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';
                    
                    if (staffType === 'ç¤¾å“¡') {
                        // ç¤¾å“¡ã®å ´åˆã‚‚æ™‚é–“å¸¯ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«æ”¹å–„
                        const note = document.createElement('div');
                        note.style.fontSize = '12px';
                        note.style.color = '#666';
                        note.style.marginBottom = '15px';
                        note.style.padding = '10px';
                        note.style.backgroundColor = '#f0f8ff';
                        note.style.borderRadius = '4px';
                        note.textContent = 'âœ“ ç¤¾å“¡ï¼šè¤‡æ•°ã®æ™‚é–“å¸¯ã‚’é¸æŠã—ã¦å‡ºå‹¤ã§ãã¾ã™ã€‚é¸æŠã—ãŸæ™‚é–“å¸¯ã§å‹¤å‹™ã¨ãªã‚Šã¾ã™ã€‚';
                        
                        container.appendChild(note);
                        
                        // ç¤¾å“¡ã«ã‚‚æ™‚é–“å¸¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
                        timeSlots.forEach(slot => {
                            addCustomSlotCheckbox(slot, currentSelectedSlots.includes(slot), 'preset');
                        });

                        // æ—¢å­˜ã®è‡ªç”±å…¥åŠ›æ™‚é–“å¸¯ã‚’è¡¨ç¤º
                        currentCustomSlots
                            .forEach(slot => addCustomSlotCheckbox(slot, true, 'custom'));

                        if (customGroup) {
                            customGroup.style.display = 'block';
                        }
                    } else {
                        // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆã¯æ™‚é–“å¸¯ã‚’è¡¨ç¤º
                        const note = document.createElement('div');
                        note.style.fontSize = '12px';
                        note.style.color = '#666';
                        note.style.marginBottom = '15px';
                        note.style.padding = '10px';
                        note.style.backgroundColor = '#fff8e1';
                        note.style.borderRadius = '4px';
                        note.textContent = 'âœ“ ã‚¢ãƒ«ãƒã‚¤ãƒˆï¼šå‹¤å‹™ã—ãŸã„æ™‚é–“å¸¯ã‚’é¸æŠã—ã¦ä¸‹ã•ã„ã€‚è¤‡æ•°é¸æŠå¯èƒ½ã§ã™ã€‚';
                        
                        container.appendChild(note);
                        
                        timeSlots.forEach(slot => {
                            addCustomSlotCheckbox(slot, currentSelectedSlots.includes(slot), 'preset');
                        });

                        // æ—¢å­˜ã®è‡ªç”±å…¥åŠ›æ™‚é–“å¸¯ã‚’è¡¨ç¤º
                        currentCustomSlots
                            .forEach(slot => addCustomSlotCheckbox(slot, true, 'custom'));

                        if (customGroup) {
                            customGroup.style.display = 'block';
                        }
                    
                    // å¤‰æ›´ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆã‚¢ãƒ«ãƒã‚¤ãƒˆã®ã¿ï¼‰
                    if (staffType !== 'ç¤¾å“¡' && currentSelectedSlots.length > 0) {
                        const changeDiv = document.createElement('div');
                        changeDiv.className = 'change-option';
                        changeDiv.innerHTML = '<h4>âš™ï¸ æ™‚é–“å¸¯ã‚’å¤‰æ›´</h4>';
                        
                        currentSelectedSlots.forEach(slot => {
                            if (changeMap[slot] && changeMap[slot].length > 0) {
                                const optionDiv = document.createElement('div');
                                optionDiv.style.marginBottom = '10px';
                                optionDiv.innerHTML = `<strong>${slot}</strong> â†’ `;
                                
                                changeMap[slot].forEach(targetSlot => {
                                    const btn = document.createElement('button');
                                    btn.textContent = targetSlot;
                                    btn.className = 'btn';
                                    btn.style.width = 'auto';
                                    btn.style.padding = '5px 10px';
                                    btn.style.marginLeft = '5px';
                                    btn.style.fontSize = '12px';
                                    btn.onclick = () => changeTimeSlot(slot, targetSlot);
                                    optionDiv.appendChild(btn);
                                });
                                
                                changeDiv.appendChild(optionDiv);
                            }
                        });
                        
                        container.appendChild(changeDiv);
                    }
                    }
                    
                    document.getElementById('shiftModal').classList.add('active');
                });
        }

            function addCustomSlotCheckbox(slot, isChecked, source = 'preset') {
            const container = document.getElementById('timeSlotCheckboxes');
            if (!container) return;

            const existing = Array.from(
                container.querySelectorAll('input[type="checkbox"]')
            ).some(cb => cb.value === slot);
            if (existing) return;

            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = slot;
            checkbox.checked = !!isChecked;
            checkbox.dataset.source = source;

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${slot}`));

            container.appendChild(label);
        }

        function addCustomTimeSlot() {
            const input = document.getElementById('customTimeSlotInput');
            if (!input) return;

            const slot = input.value.trim();
            if (!slot) {
                alert('æ™‚é–“å¸¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            addCustomSlotCheckbox(slot, true, 'custom');
            input.value = '';
        }
        
        function changeTimeSlot(fromSlot, toSlot) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¤‰æ›´
            const checkboxes = document.querySelectorAll('#timeSlotCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.value === fromSlot) {
                    cb.checked = false;
                } else if (cb.value === toSlot) {
                    cb.checked = true;
                }
            });
            
            alert(`${fromSlot} ã‚’ ${toSlot} ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚`);
        }

        async function saveShift() {
            // ç¤¾å“¡ãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆå…±ã«ã€ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ™‚é–“å¸¯ã‚’å–å¾—
            const checkboxes = document.querySelectorAll('#timeSlotCheckboxes input[type="checkbox"]:checked');
            const selectedSlots = [];
            const customSlots = [];

            Array.from(checkboxes).forEach(cb => {
                const slot = cb.value;
                const source = cb.dataset.source || 'preset';
                if (source === 'custom') {
                    customSlots.push(slot);
                } else {
                    selectedSlots.push(slot);
                }
            });
            
            const response = await fetch('/api/shifts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    date: modalData.date,
                    staff: modalData.staff,
                    time_slots: selectedSlots,
                    custom_time_slots: customSlots
                })
            });
            
            if (response.ok) {
                closeModal();
                loadShiftTable();
            }
        }

        // ã‚·ãƒ•ãƒˆç”Ÿæˆ
        let staffOrder = {};  // æœˆã”ã¨ã®ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’ä¿å­˜

        async function generateShift() {
            const response = await fetch('/api/generate');
            const months = await response.json();
            
            const container = document.getElementById('shiftResult');
            container.innerHTML = '';
            
            if (months.length === 0) {
                container.innerHTML = '<p>ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            months.forEach(monthData => {
                const monthGroup = document.createElement('div');
                monthGroup.className = 'date-group';
                
                // æœˆè¦‹å‡ºã—
                const monthHeader = document.createElement('h3');
                monthHeader.textContent = monthData.month;
                monthGroup.appendChild(monthHeader);
                
                // è¡Œé †åºèª¿æ•´ãƒ‘ãƒãƒ«
                const controlDiv = document.createElement('div');
                controlDiv.style.marginBottom = '10px';
                controlDiv.style.padding = '10px';
                controlDiv.style.backgroundColor = '#f5f5f5';
                controlDiv.style.borderRadius = '5px';
                controlDiv.innerHTML = '<small style="color: #666;">ğŸ’¡ è¡¨ã®è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</small>';
                monthGroup.appendChild(controlDiv);
                
                                // ã‚·ãƒ•ãƒˆè‰²åˆ†ã‘ã®èª¬æ˜ãƒ‘ãƒãƒ«
                                const legendDiv = document.createElement('div');
                                legendDiv.style.marginBottom = '15px';
                                legendDiv.style.padding = '10px';
                                legendDiv.style.backgroundColor = '#fffbe6';
                                legendDiv.style.borderRadius = '5px';
                                legendDiv.style.fontSize = '12px';
                                legendDiv.style.color = '#666';
                                legendDiv.innerHTML = `
                                    <strong>ğŸ“‹ ã‚·ãƒ•ãƒˆè¡¨ç¤ºã«ã¤ã„ã¦ï¼š</strong><br>
                                    <span style="display: inline-block; margin-top: 5px;">
                                        é€šå¸¸è¡¨ç¤ºï¼è‡ªå‹•ç”Ÿæˆã‚·ãƒ•ãƒˆï¼ˆè¨­å®šã«åŸºã¥ã„ã¦é…ç½®ï¼‰
                                    </span><br>
                                    <span style="display: inline-block; margin-top: 5px;">
                                        <span style="background-color: #FFB6E1; padding: 2px 6px; border-radius: 3px;">ãƒ”ãƒ³ã‚¯è‰²</span> =è‡ªç”±å…¥åŠ›ã‚·ãƒ•ãƒˆï¼ˆæ‰‹ä½œæ¥­ã§é…ç½®ãƒ»èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
                                    </span>
                                `;
                                monthGroup.appendChild(legendDiv);
                
                // è¡¨ã‚’ä½œæˆ
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.fontSize = '12px';
                table.className = 'draggable-table';
                table.dataset.month = monthData.month;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆæ—¥ä»˜ã¨æ›œæ—¥ï¼‰
                const headerRow = document.createElement('tr');
                headerRow.style.backgroundColor = '#f9f9f9';
                const th1 = document.createElement('th');
                th1.textContent = 'åå‰';
                headerRow.appendChild(th1);
                monthData.dates.forEach(d => {
                    const th = document.createElement('th');
                    th.innerHTML = `${d.day}æ—¥<br>(${d.weekday})`;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                
                // å„ã‚¹ã‚¿ãƒƒãƒ•ã®è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«
                monthData.staff_list.forEach((staff, index) => {
                    const row = document.createElement('tr');
                    row.draggable = true;
                    row.dataset.staffIndex = index;
                    row.dataset.staffName = staff.name;
                    row.style.cursor = 'grab';
                    row.style.borderBottom = '1px solid #ddd';
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    row.addEventListener('dragstart', (e) => {
                        row.style.opacity = '0.5';
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('draggedRow', row.dataset.staffIndex);
                    });
                    
                    row.addEventListener('dragend', (e) => {
                        row.style.opacity = '1';
                        document.querySelectorAll('tr[draggable=true]').forEach(r => r.style.backgroundColor = '');
                    });
                    
                    row.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        row.style.backgroundColor = '#e8f4f8';
                    });
                    
                    row.addEventListener('dragleave', (e) => {
                        row.style.backgroundColor = '';
                    });
                    
                    row.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const draggedIndex = e.dataTransfer.getData('draggedRow');
                        const targetIndex = row.dataset.staffIndex;
                        if (draggedIndex !== targetIndex) {
                            swapTableRows(table, parseInt(draggedIndex), parseInt(targetIndex));
                            saveStaffOrder(monthData.month, table);
                        }
                        row.style.backgroundColor = '';
                    });
                    
                    const td1 = document.createElement('td');
                    td1.style.textAlign = 'left';
                    td1.innerHTML = `${staff.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤'} ${staff.name}`;
                    row.appendChild(td1);
                    
                    staff.shifts.forEach((shifts, dateIdx) => {
                        const td = document.createElement('td');
                        // é¸æŠã‚·ãƒ•ãƒˆã¨è‡ªç”±å…¥åŠ›ã‚·ãƒ•ãƒˆã‚’åˆ†ã‘ã¦è¡¨ç¤º
                        const customShifts = staff.custom_shifts && staff.custom_shifts[dateIdx] ? staff.custom_shifts[dateIdx] : [];
                        
                        let html = '';
                        if (shifts.length > 0) {
                            html += shifts.join('<br>');
                        }
                        
                        // è‡ªç”±å…¥åŠ›ã‚·ãƒ•ãƒˆã‚’è‰²ä»˜ã‘ã—ã¦è¡¨ç¤º
                        if (customShifts.length > 0) {
                            if (html) html += '<br>';
                            customShifts.forEach(slot => {
                                html += `<span style="background-color: #FFB6E1; padding: 2px 4px; border-radius: 3px; display: inline-block;">${slot}</span>`;
                                if (customShifts.indexOf(slot) < customShifts.length - 1) {
                                    html += '<br>';
                                }
                            });
                        }
                        
                        td.innerHTML = html || '-';
                        td.style.textAlign = 'center';
                        td.style.cursor = 'pointer';
                        td.style.padding = '5px';
                        td.dataset.staffName = staff.name;
                        td.dataset.dateStr = monthData.dates[dateIdx].date;
                        td.dataset.currentShifts = JSON.stringify(shifts);
                        
                        // ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
                        td.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showShiftEditMenu(td, monthData.dates[dateIdx]);
                        });
                        
                        // ãƒ›ãƒãƒ¼æ™‚ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                        td.addEventListener('mouseover', () => {
                            td.style.backgroundColor = '#fff3cd';
                        });
                        td.addEventListener('mouseout', () => {
                            td.style.backgroundColor = '';
                        });
                        
                        row.appendChild(td);
                    });
                    
                    table.appendChild(row);
                });
                
                monthGroup.appendChild(table);
                
                // æœˆã”ã¨ã®ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’åˆæœŸåŒ–
                if (!staffOrder[monthData.month]) {
                    saveStaffOrder(monthData.month, table);
                }
                
                // å¿…è¦äººæ•°ãƒã‚§ãƒƒã‚¯ï¼ˆå„æ—¥ä»˜ã”ã¨ï¼‰
                const checkDiv = document.createElement('div');
                checkDiv.style.marginTop = '15px';
                checkDiv.innerHTML = '<h4>å¿…è¦äººæ•°ãƒã‚§ãƒƒã‚¯</h4>';
                
                monthData.dates.forEach(async d => {
                    const checkResponse = await fetch('/api/check_requirements', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({date: d.date})
                    });
                    const checkData = await checkResponse.json();
                    
                    const dayCheck = document.createElement('div');
                    dayCheck.style.marginBottom = '10px';
                    dayCheck.innerHTML = `<strong>${d.day}æ—¥(${d.weekday})</strong>`;
                    
                    checkData.forEach(slot => {
                        const requiredByType = slot.required_by_type || {};
                        const assignedByType = slot.assigned_by_type || {};
                        const okByType = slot.ok_by_type || {};
                        const types = sortStaffTypes(Object.keys(requiredByType));
                        const parts = types.map(type => {
                            const ok = okByType[type] ? 'âœ“' : 'âš ';
                            const assigned = assignedByType[type] ?? 0;
                            const required = requiredByType[type] ?? 0;
                            return `${type}${ok}(${assigned}/${required})`;
                        });

                        const item = document.createElement('div');
                        item.style.fontSize = '11px';
                        item.style.marginLeft = '10px';
                        item.innerHTML = `${slot.time_slot}: ${parts.join(' ')}`;
                        dayCheck.appendChild(item);
                    });
                    
                    checkDiv.appendChild(dayCheck);
                });
                
                monthGroup.appendChild(checkDiv);
                container.appendChild(monthGroup);
            });
        }
        
        function swapTableRows(table, index1, index2) {
            const rows = Array.from(table.querySelectorAll('tr[draggable=true]'));
            if (rows[index1] && rows[index2]) {
                const temp = rows[index1].cloneNode(true);
                rows[index1].replaceWith(rows[index2].cloneNode(true));
                rows[index2].replaceWith(temp);
                // æ–°ã—ã„è¡Œã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†åº¦è¨­å®š
                Array.from(table.querySelectorAll('tr[draggable=true]')).forEach((row, idx) => {
                    row.dataset.staffIndex = idx;
                    row.addEventListener('dragstart', handleDragStart);
                    row.addEventListener('dragend', handleDragEnd);
                    row.addEventListener('dragover', handleDragOver);
                    row.addEventListener('dragleave', handleDragLeave);
                    row.addEventListener('drop', handleDrop);
                });
            }
        }
        
        function handleDragStart(e) {
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('draggedRow', this.dataset.staffIndex);
        }
        
        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            document.querySelectorAll('tr[draggable=true]').forEach(r => r.style.backgroundColor = '');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            this.style.backgroundColor = '#e8f4f8';
        }
        
        function handleDragLeave(e) {
            this.style.backgroundColor = '';
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const draggedIndex = e.dataTransfer.getData('draggedRow');
            const targetIndex = this.dataset.staffIndex;
            if (draggedIndex !== targetIndex) {
                const table = this.closest('table');
                swapTableRows(table, parseInt(draggedIndex), parseInt(targetIndex));
                saveStaffOrder(table.dataset.month, table);
            }
            this.style.backgroundColor = '';
        }
        
        function saveStaffOrder(month, table) {
            const order = [];
            table.querySelectorAll('tr[draggable=true]').forEach(row => {
                order.push(row.dataset.staffName);
            });
            staffOrder[month] = order;
        }
        
        function getStaffOrder(month) {
            return staffOrder[month] || null;
        }
        
        // ã‚·ãƒ•ãƒˆç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showShiftEditMenu(td, dateInfo) {
            const staffName = td.dataset.staffName;
            const dateStr = td.dataset.dateStr;
            const currentShifts = JSON.parse(td.dataset.currentShifts);
            
            // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
            const existingMenu = document.getElementById('shiftEditMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¦ç´ ã‚’ä½œæˆ
            const menu = document.createElement('div');
            menu.id = 'shiftEditMenu';
            menu.style.position = 'fixed';
            menu.style.top = event.clientY + 'px';
            menu.style.left = event.clientX + 'px';
            menu.style.backgroundColor = 'white';
            menu.style.border = '1px solid #ccc';
            menu.style.borderRadius = '4px';
            menu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            menu.style.zIndex = '10000';
            menu.style.minWidth = '150px';
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ
            
            const options = ['ã‚·ãƒ•ãƒˆãªã—'].concat(timeSlots);
            options.forEach(opt => {
                const item = document.createElement('div');
                item.style.padding = '8px 12px';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid #eee';
                
                const displayName = opt === 'ã‚·ãƒ•ãƒˆãªã—' ? '-' : opt;
                const isSelected = opt === 'ã‚·ãƒ•ãƒˆãªã—' ? currentShifts.length === 0 : currentShifts.includes(opt);
                
                item.innerHTML = isSelected ? `âœ“ ${displayName}` : displayName;
                item.style.backgroundColor = isSelected ? '#e8f4f8' : 'white';
                
                item.addEventListener('mouseover', () => {
                    item.style.backgroundColor = '#f0f0f0';
                });
                item.addEventListener('mouseout', () => {
                    item.style.backgroundColor = isSelected ? '#e8f4f8' : 'white';
                });
                
                item.addEventListener('click', async () => {
                    // ã‚·ãƒ•ãƒˆã‚’æ›´æ–°
                    const newShifts = opt === 'ã‚·ãƒ•ãƒˆãªã—' ? [] : [opt];
                    await updateShift(staffName, dateStr, newShifts);
                    menu.remove();
                });
                
                menu.appendChild(item);
            });
            
            document.body.appendChild(menu);
            
            // å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‰ã˜ã‚‹
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }
        
        // ã‚·ãƒ•ãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¦æ›´æ–°
        async function updateShift(staffName, dateStr, newShifts) {
            try {
                console.log('Updating shift:', {staffName, dateStr, newShifts});
                
                const response = await fetch('/api/update-shift', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        staff_name: staffName,
                        date: dateStr,
                        shifts: newShifts
                    })
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response body:', result);
                
                if (response.ok) {
                    if (result.success) {
                        console.log('Update successful, regenerating shift...');
                        // è¡¨ã‚’å†ç”Ÿæˆã—ã¦åæ˜ 
                        await generateShift();
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                    }
                } else {
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + response.status);
                }
            } catch (error) {
                console.error('Error updating shift:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function exportCSV() {
            // ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
            const orderData = JSON.stringify(staffOrder);
            window.location.href = `/api/export/csv?order=${encodeURIComponent(orderData)}`;
        }

        // æœˆåˆ‡ã‚Šæ›¿ãˆ
        function changeMonth(delta, type) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            if (type === 'shifts') {
                loadShiftTable();
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // åˆæœŸåŒ–ã¯ initializeUI() ã«çµ±ä¸€æ¸ˆã¿
        

        // ========== ã‚·ãƒ•ãƒˆè©³ç´°è¨­å®šé–¢é€£ ==========
        
        let currentTimeSlots = [];
        let currentStaffTypes = [];

        async function loadShiftSettings() {
            try {
                const response = await fetch('/api/shift-settings');
                const data = await response.json();
                
                if (data.success) {
                    currentTimeSlots = data.time_slots || ['10-15', '17-23', '18-23', '19-23'];
                    currentStaffTypes = data.staff_types || ['ç¤¾å“¡', 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ'];
                    displayTimeSlots(currentTimeSlots);
                    displayShiftSettings(data.settings, currentTimeSlots);
                }
            } catch (error) {
                console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function sortStaffTypes(types) {
            const priority = {'ç¤¾å“¡': 0, 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ': 1};
            return [...types].sort((a, b) => {
                const pa = priority.hasOwnProperty(a) ? priority[a] : 2;
                const pb = priority.hasOwnProperty(b) ? priority[b] : 2;
                if (pa !== pb) return pa - pb;
                return a.localeCompare(b, 'ja');
            });
        }

        function renderSettingsHeader(headId, staffTypes) {
            const headRow = document.getElementById(headId);
            if (!headRow) return;

            headRow.innerHTML = '';
            const timeHeader = document.createElement('th');
            timeHeader.textContent = 'æ™‚é–“å¸¯';
            timeHeader.style.padding = '10px';
            timeHeader.style.textAlign = 'left';
            timeHeader.style.border = '1px solid #ddd';
            headRow.appendChild(timeHeader);

            staffTypes.forEach(type => {
                const th = document.createElement('th');
                th.textContent = type;
                th.style.padding = '10px';
                th.style.textAlign = 'center';
                th.style.border = '1px solid #ddd';
                headRow.appendChild(th);
            });
        }

        function displayTimeSlots(timeSlots) {
            const container = document.getElementById('timeSlotsList');
            container.innerHTML = '';
            
            timeSlots.forEach(slot => {
                const tag = document.createElement('div');
                tag.className = 'time-slot-tag';
                tag.draggable = true;
                tag.dataset.slot = slot;
                tag.innerHTML = `
                    <span style="cursor: grab;">drag</span>
                    <span>${slot}</span>
                    <button class="remove-btn" onclick="removeTimeSlot('${slot}')" title="å‰Šé™¤">Ã—</button>
                `;
                tag.addEventListener('dragstart', (event) => {
                    event.dataTransfer.setData('text/plain', slot);
                    tag.style.opacity = '0.6';
                });
                tag.addEventListener('dragend', () => {
                    tag.style.opacity = '1';
                });
                tag.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    tag.style.outline = '2px dashed #2196F3';
                });
                tag.addEventListener('dragleave', () => {
                    tag.style.outline = '';
                });
                tag.addEventListener('drop', (event) => {
                    event.preventDefault();
                    tag.style.outline = '';
                    const fromSlot = event.dataTransfer.getData('text/plain');
                    if (fromSlot && fromSlot !== slot) {
                        moveTimeSlot(fromSlot, slot);
                    }
                });
                container.appendChild(tag);
            });
        }

        function moveTimeSlot(fromSlot, toSlot) {
            const fromIndex = currentTimeSlots.indexOf(fromSlot);
            const toIndex = currentTimeSlots.indexOf(toSlot);
            if (fromIndex === -1 || toIndex === -1) return;

            const updated = [...currentTimeSlots];
            const [moved] = updated.splice(fromIndex, 1);
            updated.splice(toIndex, 0, moved);
            currentTimeSlots = updated;
            displayTimeSlots(currentTimeSlots);
            saveTimeSlotOrder();
        }

        async function saveTimeSlotOrder() {
            try {
                const response = await fetch('/api/time-slots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_slots: currentTimeSlots})
                });

                const data = await response.json();

                if (data.success) {
                    loadShiftSettings();
                } else {
                    alert('âŒ ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                }
            } catch (error) {
                console.error('æ™‚é–“å¸¯ä¸¦ã³æ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ä¸¦ã³æ›¿ãˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function addTimeSlot() {
            const input = document.getElementById('newTimeSlot');
            const newSlot = input.value.trim();
            
            if (!newSlot) {
                alert('æ™‚é–“å¸¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼š10-15, 17:30-23:00, ã¾ãŸã¯æƒé™¤ãªã©ã®æ–‡å­—ï¼‰
            const timeSlotPattern = /^(\d{1,2})(?::([0-5]\d))?-(\d{1,2})(?::([0-5]\d))?$/;
            const match = newSlot.match(timeSlotPattern);
            
            if (match) {
                // æ™‚é–“å½¢å¼ã®å ´åˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                const startHour = parseInt(match[1], 10);
                const startMin = match[2] ? parseInt(match[2], 10) : 0;
                const endHour = parseInt(match[3], 10);
                const endMin = match[4] ? parseInt(match[4], 10) : 0;

                if (startHour > 29 || endHour > 29) {
                    alert('æ™‚é–“ã¯0-29ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š29:00ï¼‰');
                    return;
                }

                if (startMin % 30 !== 0 || endMin % 30 !== 0) {
                    alert('åˆ†ã¯00ã¾ãŸã¯30ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š17:30ï¼‰');
                    return;
                }
            } else {
                // æ–‡å­—å½¢å¼ã®å ´åˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æœ¬èªã‚„è‹±å­—ãªã©ï¼‰
                if (!/^[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ffa-zA-Z0-9\-_]+$/.test(newSlot)) {
                    alert('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\n\næ™‚é–“å½¢å¼: ã€Œé–‹å§‹-çµ‚äº†ã€ï¼ˆä¾‹ï¼š10-15, 17:30-23:00ï¼‰\næ–‡å­—å½¢å¼: æ—¥æœ¬èªã€è‹±å­—ã€æ•°å­— ï¼ˆä¾‹ï¼šæƒé™¤, å–¶æ¥­æº–å‚™, cleaningï¼‰');
                    return;
                }
            }
            
            if (currentTimeSlots.includes(newSlot)) {
                alert('ã“ã®æ™‚é–“å¸¯ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            currentTimeSlots.push(newSlot);
            
            try {
                const response = await fetch('/api/time-slots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_slots: currentTimeSlots})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    input.value = '';
                    loadShiftSettings(); // å†èª­ã¿è¾¼ã¿
                    alert('âœ… æ™‚é–“å¸¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                } else {
                    alert('âŒ è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                    currentTimeSlots.pop(); // å¤±æ•—ã—ãŸã‚‰æˆ»ã™
                }
            } catch (error) {
                console.error('æ™‚é–“å¸¯è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                currentTimeSlots.pop();
            }
        }

        async function removeTimeSlot(slot) {
            if (!confirm(`æ™‚é–“å¸¯ã€Œ${slot}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» ã“ã®æ™‚é–“å¸¯ã«é–¢é€£ã™ã‚‹ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚å½±éŸ¿ã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`)) {
                return;
            }
            
            currentTimeSlots = currentTimeSlots.filter(s => s !== slot);
            
            try {
                const response = await fetch('/api/time-slots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_slots: currentTimeSlots})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadShiftSettings(); // å†èª­ã¿è¾¼ã¿
                    alert('âœ… æ™‚é–“å¸¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                    currentTimeSlots.push(slot); // å¤±æ•—ã—ãŸã‚‰æˆ»ã™
                }
            } catch (error) {
                console.error('æ™‚é–“å¸¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                currentTimeSlots.push(slot);
            }
        }

        function displayShiftSettings(settings, timeSlots) {
            if (!timeSlots) {
                timeSlots = ['10-15', '17-23', '18-23', '19-23'];
            }

            const staffTypes = sortStaffTypes(currentStaffTypes.length ? currentStaffTypes : ['ç¤¾å“¡', 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ']);
            renderSettingsHeader('weekdaySettingsHead', staffTypes);
            renderSettingsHeader('weekendSettingsHead', staffTypes);
            
            // å¹³æ—¥è¨­å®šã‚’è¡¨ç¤ºï¼ˆæ™‚é–“å¸¯ãƒªã‚¹ãƒˆã®é †åºã«å¾“ã†ï¼‰
            const weekdayTbody = document.getElementById('weekdaySettings');
            weekdayTbody.innerHTML = '';
            timeSlots.forEach((slot, slotIndex) => {
                const config = settings.weekday[slot] || {};
                const row = document.createElement('tr');
                const cells = [];
                
                // æ™‚é–“å¸¯
                cells.push(`<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${slot}</td>`);

                // ã‚¹ã‚¿ãƒƒãƒ•ç¨®åˆ¥ã”ã¨ã®å…¥åŠ›
                staffTypes.forEach(type => {
                    const value = Number.isFinite(config[type]) ? config[type] : (config[type] || 0);
                    cells.push(`
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                            <input type="number" min="0" max="10" value="${value}" 
                                   data-day="weekday" data-slot="${slot}" data-type="${type}"
                                   style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                    `);
                });

                row.innerHTML = cells.join('');
                weekdayTbody.appendChild(row);
            });
            
            // é€±æœ«è¨­å®šã‚’è¡¨ç¤ºï¼ˆæ™‚é–“å¸¯ãƒªã‚¹ãƒˆã®é †åºã«å¾“ã†ï¼‰
            const weekendTbody = document.getElementById('weekendSettings');
            weekendTbody.innerHTML = '';
            timeSlots.forEach((slot, slotIndex) => {
                const config = settings.weekend[slot] || {};
                const row = document.createElement('tr');
                const cells = [];
                
                // æ™‚é–“å¸¯
                cells.push(`<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${slot}</td>`);

                // ã‚¹ã‚¿ãƒƒãƒ•ç¨®åˆ¥ã”ã¨ã®å…¥åŠ›
                staffTypes.forEach(type => {
                    const value = Number.isFinite(config[type]) ? config[type] : (config[type] || 0);
                    cells.push(`
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                            <input type="number" min="0" max="10" value="${value}" 
                                   data-day="weekend" data-slot="${slot}" data-type="${type}"
                                   style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                    `);
                });

                row.innerHTML = cells.join('');
                weekendTbody.appendChild(row);
            });
        }

        async function saveShiftSettings() {
            try {
                // å…¥åŠ›å€¤ã‹ã‚‰è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                const settings = {
                    weekday: {},
                    weekend: {}
                };
                
                // ç¾åœ¨ã®æ™‚é–“å¸¯ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
                const timeSlots = currentTimeSlots;
                const staffTypes = sortStaffTypes(currentStaffTypes.length ? currentStaffTypes : ['ç¤¾å“¡', 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ']);
                
                // å¹³æ—¥è¨­å®š
                timeSlots.forEach(slot => {
                    settings.weekday[slot] = {};
                    staffTypes.forEach(type => {
                        const input = document.querySelector(
                            `input[data-day="weekday"][data-slot="${slot}"][data-type="${type}"]`
                        );
                        settings.weekday[slot][type] = parseInt(input?.value, 10) || 0;
                    });
                });
                
                // é€±æœ«è¨­å®š
                timeSlots.forEach(slot => {
                    settings.weekend[slot] = {};
                    staffTypes.forEach(type => {
                        const input = document.querySelector(
                            `input[data-day="weekend"][data-slot="${slot}"][data-type="${type}"]`
                        );
                        settings.weekend[slot][type] = parseInt(input?.value, 10) || 0;
                    });
                });
                
                const response = await fetch('/api/shift-settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({settings: settings})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } else {
                    alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                }
            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function resetShiftSettings() {
            if (!confirm('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            // ç¾åœ¨ã®æ™‚é–“å¸¯ã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ç”Ÿæˆ
            const defaultSettings = {
                weekday: {},
                weekend: {}
            };
            
            const staffTypes = sortStaffTypes(currentStaffTypes.length ? currentStaffTypes : ['ç¤¾å“¡', 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ']);
            currentTimeSlots.forEach(slot => {
                defaultSettings.weekday[slot] = {};
                defaultSettings.weekend[slot] = {};
                staffTypes.forEach(type => {
                    const isDefault = type === 'ç¤¾å“¡' || type === 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';
                    const value = isDefault ? 1 : 0;
                    defaultSettings.weekday[slot][type] = value;
                    defaultSettings.weekend[slot][type] = value;
                });
            });
            
            displayShiftSettings(defaultSettings, currentTimeSlots);
            alert('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
        }

        // ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´é–¢é€£ ==========

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!currentPassword) {
                alert('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!newPassword) {
                alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (newPassword.length < 4) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                return;
            }

            if (currentPassword === newPassword) {
                alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç•°ãªã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\nå¤‰æ›´å¾Œã¯æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚')) {
                return;
            }

            try {
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼\næ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚');
                    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                }
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

    </script>
</body>
</html>
