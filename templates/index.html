<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            padding-bottom: 60px;
        }

        .header {
            background-color: #2196F3;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            margin: 0;
            flex: 1;
            text-align: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .role-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            background-color: white;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: white;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid #2196F3;
            color: #2196F3;
            font-weight: bold;
        }

        .content {
            display: none;
            padding: 15px;
        }

        .content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .staff-list {
            list-style: none;
        }

        .staff-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .staff-item:last-child {
            border-bottom: none;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-nav button {
            padding: 8px 15px;
            border: 1px solid #2196F3;
            background: white;
            color: #2196F3;
            border-radius: 4px;
            cursor: pointer;
        }

        .month-nav h3 {
            font-size: 18px;
        }

        .shift-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }

        th {
            background-color: #2196F3;
            color: white;
            position: sticky;
            top: 0;
        }

        td.staff-name {
            font-weight: 500;
            background-color: #f9f9f9;
            text-align: left;
            position: sticky;
            left: 0;
        }

        td.clickable {
            cursor: pointer;
            min-width: 60px;
        }

        td.clickable:hover {
            background-color: #e3f2fd;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h3 {
            margin-bottom: 15px;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-group label {
            display: block;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .checkbox-group label:has(input:checked) {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }
        
        .change-option {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            border: 1px solid #ffc107;
        }
        
        .change-option h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #856404;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .shift-result {
            max-height: 60vh;
            overflow-y: auto;
        }

        .date-group {
            margin-bottom: 20px;
        }

        .date-group h3 {
            background-color: #2196F3;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .shift-item {
            padding: 8px;
            border-left: 3px solid #4CAF50;
            background-color: #f9f9f9;
            margin-bottom: 5px;
            padding-left: 10px;
        }

        .requirement-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            padding-left: 10px;
        }

        .requirement-item.satisfied {
            background-color: #d4edda;
            border-left-color: #28a745;
        }

        .requirement-item.unsatisfied {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

        .time-slot-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: #1976d2;
        }

        .time-slot-tag .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .time-slot-tag .remove-btn:hover {
            background: #d32f2f;
        }

        @media (max-width: 600px) {
            .tabs {
                font-size: 12px;
            }
            
            .tab {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“… ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</h1>
        <div class="header-right">
            <span class="role-badge" id="storeBadge">åº—èˆ—: èª­è¾¼ä¸­</span>
            <span class="role-badge" id="roleBadge">ç®¡ç†è€…</span>
            <button class="logout-btn" onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('staff', event)">ã‚¹ã‚¿ãƒƒãƒ•</button>
        <button class="tab" onclick="showTab('shifts', event)">ã‚·ãƒ•ãƒˆå¸Œæœ›</button>
        <button class="tab" onclick="showTab('generate', event)">ã‚·ãƒ•ãƒˆè¡¨</button>
        <button class="tab" onclick="showTab('settings', event)">è©³ç´°è¨­å®š</button>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã‚¿ãƒ– -->
    <div id="staff" class="content active">
        <div class="card">
            <h2>ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h2>
            <div class="form-group">
                <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                <input type="text" id="staffName" placeholder="åå‰ã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label>ç¨®åˆ¥</label>
                <select id="staffType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                    <option value="ã‚¢ãƒ«ãƒã‚¤ãƒˆ">ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
                    <option value="ç¤¾å“¡">ç¤¾å“¡</option>
                </select>
            </div>
            <button type="button" class="btn btn-primary" id="addStaffBtn" onclick="console.log('Button clicked!'); addStaff();">è¿½åŠ </button>
        </div>

        <div class="card">
            <h2>ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•</h2>
            <ul class="staff-list" id="staffList"></ul>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›ã‚¿ãƒ– -->
    <div id="shifts" class="content">
        <div class="card">
            <div class="month-nav">
                <button onclick="changeMonth(-1, 'shifts')">â—€ å‰æœˆ</button>
                <h3 id="shiftMonth"></h3>
                <button onclick="changeMonth(1, 'shifts')">æ¬¡æœˆ â–¶</button>
            </div>
            <div class="shift-table">
                <table id="shiftTable"></table>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆã‚¿ãƒ– -->
    <div id="generate" class="content">
        <div class="card">
            <h2>ã‚·ãƒ•ãƒˆç”Ÿæˆ</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                â€»ã‚·ãƒ•ãƒˆã¯è‡ªå‹•çš„ã«æœ€é©åŒ–ã•ã‚Œã¾ã™ã€‚å¿…è¦äººæ•°ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã€é©æ­£äººæ•°ã¾ã§èª¿æ•´ã•ã‚Œã¾ã™ã€‚
            </p>
            <button class="btn btn-success" onclick="generateShift()">ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆ</button>
            <button class="btn btn-primary" onclick="exportCSV()" style="margin-top: 10px;">PDFå‡ºåŠ›</button>
        </div>
        <div class="card">
            <h2>ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ•ãƒˆ</h2>
            <div class="shift-result" id="shiftResult"></div>
        </div>
    </div>

    <!-- è©³ç´°è¨­å®šã‚¿ãƒ– -->
    <div id="settings" class="content">
        <div class="card">
            <h2>ğŸ• æ™‚é–“å¸¯ç®¡ç†</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                ã‚·ãƒ•ãƒˆã§ä½¿ç”¨ã™ã‚‹æ™‚é–“å¸¯ã‚’ç®¡ç†ã—ã¾ã™ã€‚æ™‚é–“å¸¯ã‚’è¿½åŠ ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚
            </p>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; font-size: 16px;">ç¾åœ¨ã®æ™‚é–“å¸¯</h3>
                <div id="timeSlotsList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="text" id="newTimeSlot" placeholder="ä¾‹ï¼š14-18" 
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <button class="btn btn-primary" onclick="addTimeSlot()">â• æ™‚é–“å¸¯ã‚’è¿½åŠ </button>
                </div>
                <p style="font-size: 11px; color: #999; margin-top: 5px;">
                    â€» å½¢å¼: ã€Œé–‹å§‹æ™‚-çµ‚äº†æ™‚ã€ï¼ˆä¾‹ï¼š10-15, 17-23ï¼‰
                </p>
            </div>
        </div>

        <div class="card">
            <h2>âš™ï¸ ã‚·ãƒ•ãƒˆè©³ç´°è¨­å®š</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                æ™‚é–“å¸¯ã”ã¨ã®å¿…è¦äººæ•°ã‚’è¨­å®šã§ãã¾ã™ã€‚ã‚·ãƒ•ãƒˆç”Ÿæˆæ™‚ã«ã“ã®è¨­å®šãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
            </p>

            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #2196F3;">ğŸ“… å¹³æ—¥ï¼ˆæ—¥ã€œæœ¨ï¼‰</h3>
            <div class="settings-table">
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">æ™‚é–“å¸¯</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">ç¤¾å“¡</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">ã‚¢ãƒ«ãƒã‚¤ãƒˆ</th>
                        </tr>
                    </thead>
                    <tbody id="weekdaySettings">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #2196F3;">ğŸ‰ é€±æœ«ï¼ˆé‡‘ãƒ»åœŸï¼‰</h3>
            <div class="settings-table">
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">æ™‚é–“å¸¯</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">ç¤¾å“¡</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">ã‚¢ãƒ«ãƒã‚¤ãƒˆ</th>
                        </tr>
                    </thead>
                    <tbody id="weekendSettings">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <button class="btn btn-primary" onclick="saveShiftSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            <button class="btn" onclick="resetShiftSettings()" style="margin-left: 10px;">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
        </div>

        <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card">
            <h2>ğŸ” ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                ã“ã®åº—èˆ—ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚å¤‰æ›´å¾Œã¯æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </p>

            <div class="form-group">
                <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="currentPassword" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="off"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="newPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆ4æ–‡å­—ä»¥ä¸Šï¼‰" autocomplete="off"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                <input type="password" id="confirmPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›" autocomplete="off"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <button class="btn btn-primary" onclick="changePassword()">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›ï¼‰ -->
    <div id="shiftModal" class="modal">
        <div class="modal-content">
            <h3>ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</h3>
            <p id="modalInfo"></p>
            <div class="checkbox-group" id="timeSlotCheckboxes"></div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveShift()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let currentStaff = [];
        let timeSlots = [];
        let changeMap = {};  // æ™‚é–“å¸¯å¤‰æ›´ãƒãƒƒãƒ—
        let modalData = {};
        let userRole = 'user';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
        });

        // UIåˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ãƒ«åˆ¥ï¼‰
        function initializeUI() {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ã¾ãŸã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ï¼‰
            // ç°¡æ˜“çš„ã«ã¯ã€ãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹ã‚’ç¢ºèª
            fetch('/api/check-auth')
                .then(response => {
                    if (response.status === 401) {
                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.role) {
                        userRole = data.role;
                        // åº—èˆ—æƒ…å ±ã‚’è¡¨ç¤º
                        const storeBadge = document.getElementById('storeBadge');
                        if (data.store_code) {
                            storeBadge.textContent = `ğŸª ${data.store_code}`;
                        }
                        applyRoleBasedUI(data.role);
                    }
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    window.location.href = '/login';
                });
        }

        // ãƒ­ãƒ¼ãƒ«åˆ¥UIé©ç”¨
        function applyRoleBasedUI(role) {
            const roleBadge = document.getElementById('roleBadge');
            const tabs = document.querySelectorAll('.tab');
            
            if (role === 'admin') {
                roleBadge.textContent = 'ğŸ‘” ç®¡ç†è€…';
                // ç®¡ç†è€…ç”¨ã‚¿ãƒ–ã‚’ã™ã¹ã¦è¡¨ç¤º
                tabs.forEach(tab => tab.style.display = 'block');
                // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
                if (tabs.length > 0) {
                    setTimeout(() => showTab('staff', {target: tabs[0]}), 100);
                }
            } else {
                roleBadge.textContent = 'ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•';
                // ã‚¹ã‚¿ãƒƒãƒ•ç”¨ã‚¿ãƒ–ã®ã¿è¡¨ç¤ºï¼ˆã€Œã‚·ãƒ•ãƒˆå¸Œæœ›ã€ã®ã¿ï¼‰
                tabs.forEach((tab, index) => {
                    if (tab.textContent.includes('ã‚·ãƒ•ãƒˆå¸Œæœ›')) {
                        tab.style.display = 'block';
                    } else {
                        tab.style.display = 'none';
                    }
                });
                // ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚¿ãƒ–ã‚’æœ€åˆã«è¡¨ç¤º
                setTimeout(() => {
                    const shiftsTab = Array.from(tabs).find(t => t.textContent.includes('ã‚·ãƒ•ãƒˆå¸Œæœ›'));
                    if (shiftsTab) {
                        showTab('shifts', {target: shiftsTab});
                    }
                }, 100);
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await fetch('/api/logout', {method: 'POST'});
                    window.location.href = '/login';
                } catch (error) {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'staff') {
                loadStaff();
            } else if (tabName === 'shifts') {
                loadShiftTable();
            } else if (tabName === 'settings') {
                loadShiftSettings();
            }
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
        async function loadStaff() {
            try {
                const response = await fetch('/api/staff');
                const staffData = await response.json();
                currentStaff = staffData;
                
                const list = document.getElementById('staffList');
                list.innerHTML = '';
                
                if (Object.keys(currentStaff).length === 0) {
                    list.innerHTML = '<li class="staff-item">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</li>';
                    return;
                }
            
                Object.entries(currentStaff).sort().forEach(([name, info]) => {
                    const li = document.createElement('li');
                    li.className = 'staff-item';
                    const badge = info.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤';
                    li.innerHTML = `
                        <span>${badge} ${name} (${info.type})</span>
                        <button class="btn btn-danger" style="width: auto; padding: 8px 15px;" onclick="deleteStaff('${name}')">å‰Šé™¤</button>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Error in loadStaff:', error);
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function addStaff() {
            try {
                console.log('addStaff function called');
                const name = document.getElementById('staffName').value.trim();
                const type = document.getElementById('staffType').value;
                console.log('Name:', name, 'Type:', type);
                
                if (!name) {
                    alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const response = await fetch('/api/staff', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, type})
                });

                const result = await response.json();
                console.log('Response:', result);
                
                if (response.ok) {
                    document.getElementById('staffName').value = '';
                    loadStaff();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                console.error('Error in addStaff:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteStaff(name) {
            try {
                if (!confirm(`${name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

                const response = await fetch(`/api/staff/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadStaff();
                } else {
                    const result = await response.json();
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Error in deleteStaff:', error);
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›
        async function loadShiftTable() {
            const response = await fetch(`/api/shifts/${currentYear}/${currentMonth}`);
            const data = await response.json();
            
            currentStaff = data.staff;
            timeSlots = data.time_slots;
            
            document.getElementById('shiftMonth').textContent = `${currentYear}å¹´${currentMonth}æœˆ`;
            
            const table = document.getElementById('shiftTable');
            table.innerHTML = '';
            
            if (Object.keys(currentStaff).length === 0) {
                table.innerHTML = '<tr><td colspan="100%">ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</td></tr>';
                return;
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            let headerRow = '<tr><th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            for (let day = 1; day <= data.days_in_month; day++) {
                const dayOfWeek = new Date(currentYear, currentMonth - 1, day).getDay();
                const weekday = weekdays[dayOfWeek];
                headerRow += `<th>${day}æ—¥<br>(${weekday})</th>`;
            }
            headerRow += '</tr>';
            table.innerHTML = headerRow;
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            Object.entries(currentStaff).sort().forEach(([staffName, staffInfo]) => {
                const badge = staffInfo.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤';
                let row = `<tr><td class="staff-name">${badge} ${staffName}</td>`;
                for (let day = 1; day <= data.days_in_month; day++) {
                    const date = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const slots = data.shifts[date]?.[staffName] || [];
                    const display = slots.join(', ');
                    
                    row += `<td class="clickable" onclick="openShiftModal('${date}', '${staffName}')">${display}</td>`;
                }
                row += '</tr>';
                table.innerHTML += row;
            });
        }

        function openShiftModal(date, staff) {
            modalData = {date, staff};
            
            document.getElementById('modalInfo').textContent = `${date} - ${staff}`;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            const container = document.getElementById('timeSlotCheckboxes');
            container.innerHTML = '';
            
            // ç¾åœ¨ã®é¸æŠã‚’å–å¾—
            fetch(`/api/shifts/${currentYear}/${currentMonth}`)
                .then(res => res.json())
                .then(data => {
                    const currentSlots = data.shifts[date]?.[staff] || [];
                    changeMap = data.change_map || {};
                    
                    // ã‚¹ã‚¿ãƒƒãƒ•ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
                    const staffType = currentStaff[staff]?.type || 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';
                    
                    if (staffType === 'ç¤¾å“¡') {
                        // ç¤¾å“¡ã®å ´åˆã¯ã€Œå‡ºå‹¤ã€ã®ã¿è¡¨ç¤º
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = 'work';
                        checkbox.checked = currentSlots.length > 0;
                        checkbox.id = 'workCheckbox';
                        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' å‡ºå‹¤'));
                        
                        const note = document.createElement('div');
                        note.style.fontSize = '12px';
                        note.style.color = '#666';
                        note.style.marginTop = '10px';
                        note.textContent = 'â€»ç¤¾å“¡ã¯é€šã—å‹¤å‹™ï¼ˆãƒ©ãƒ³ãƒï¼‹ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰ã§ã™';
                        
                        container.appendChild(label);
                        container.appendChild(note);
                    } else {
                        // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆã¯æ™‚é–“å¸¯ã‚’è¡¨ç¤º
                        timeSlots.forEach(slot => {
                            const label = document.createElement('label');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = slot;
                            checkbox.checked = currentSlots.includes(slot);
                            
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(` ${slot}`));
                            
                            container.appendChild(label);
                        });
                    
                    // å¤‰æ›´ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆã‚¢ãƒ«ãƒã‚¤ãƒˆã®ã¿ï¼‰
                    if (staffType === 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ' && currentSlots.length > 0) {
                        const changeDiv = document.createElement('div');
                        changeDiv.className = 'change-option';
                        changeDiv.innerHTML = '<h4>âš™ï¸ æ™‚é–“å¸¯ã‚’å¤‰æ›´</h4>';
                        
                        currentSlots.forEach(slot => {
                            if (changeMap[slot] && changeMap[slot].length > 0) {
                                const optionDiv = document.createElement('div');
                                optionDiv.style.marginBottom = '10px';
                                optionDiv.innerHTML = `<strong>${slot}</strong> â†’ `;
                                
                                changeMap[slot].forEach(targetSlot => {
                                    const btn = document.createElement('button');
                                    btn.textContent = targetSlot;
                                    btn.className = 'btn';
                                    btn.style.width = 'auto';
                                    btn.style.padding = '5px 10px';
                                    btn.style.marginLeft = '5px';
                                    btn.style.fontSize = '12px';
                                    btn.onclick = () => changeTimeSlot(slot, targetSlot);
                                    optionDiv.appendChild(btn);
                                });
                                
                                changeDiv.appendChild(optionDiv);
                            }
                        });
                        
                        container.appendChild(changeDiv);
                    }
                    }
                    
                    document.getElementById('shiftModal').classList.add('active');
                });
        }
        
        function changeTimeSlot(fromSlot, toSlot) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¤‰æ›´
            const checkboxes = document.querySelectorAll('#timeSlotCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.value === fromSlot) {
                    cb.checked = false;
                } else if (cb.value === toSlot) {
                    cb.checked = true;
                }
            });
            
            alert(`${fromSlot} ã‚’ ${toSlot} ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚`);
        }

        async function saveShift() {
            const staffType = currentStaff[modalData.staff]?.type || 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';
            let selectedSlots;
            
            if (staffType === 'ç¤¾å“¡') {
                // ç¤¾å“¡ã®å ´åˆã€å‡ºå‹¤ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚Œã°å…¨æ™‚é–“å¸¯ã‚’è¨­å®š
                const workCheckbox = document.getElementById('workCheckbox');
                if (workCheckbox && workCheckbox.checked) {
                    selectedSlots = ['10-15', '17-23'];
                } else {
                    selectedSlots = [];
                }
            } else {
                // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ™‚é–“å¸¯ã‚’å–å¾—
                const checkboxes = document.querySelectorAll('#timeSlotCheckboxes input[type="checkbox"]:checked');
                selectedSlots = Array.from(checkboxes).map(cb => cb.value);
            }
            
            const response = await fetch('/api/shifts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    date: modalData.date,
                    staff: modalData.staff,
                    time_slots: selectedSlots
                })
            });
            
            if (response.ok) {
                closeModal();
                loadShiftTable();
            }
        }

        // ã‚·ãƒ•ãƒˆç”Ÿæˆ
        let staffOrder = {};  // æœˆã”ã¨ã®ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’ä¿å­˜

        async function generateShift() {
            const response = await fetch('/api/generate');
            const months = await response.json();
            
            const container = document.getElementById('shiftResult');
            container.innerHTML = '';
            
            if (months.length === 0) {
                container.innerHTML = '<p>ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            months.forEach(monthData => {
                const monthGroup = document.createElement('div');
                monthGroup.className = 'date-group';
                
                // æœˆè¦‹å‡ºã—
                const monthHeader = document.createElement('h3');
                monthHeader.textContent = monthData.month;
                monthGroup.appendChild(monthHeader);
                
                // è¡Œé †åºèª¿æ•´ãƒ‘ãƒãƒ«
                const controlDiv = document.createElement('div');
                controlDiv.style.marginBottom = '10px';
                controlDiv.style.padding = '10px';
                controlDiv.style.backgroundColor = '#f5f5f5';
                controlDiv.style.borderRadius = '5px';
                controlDiv.innerHTML = '<small style="color: #666;">ğŸ’¡ è¡¨ã®è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</small>';
                monthGroup.appendChild(controlDiv);
                
                // è¡¨ã‚’ä½œæˆ
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.fontSize = '12px';
                table.className = 'draggable-table';
                table.dataset.month = monthData.month;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆæ—¥ä»˜ã¨æ›œæ—¥ï¼‰
                const headerRow = document.createElement('tr');
                headerRow.style.backgroundColor = '#f9f9f9';
                const th1 = document.createElement('th');
                th1.textContent = 'åå‰';
                headerRow.appendChild(th1);
                monthData.dates.forEach(d => {
                    const th = document.createElement('th');
                    th.innerHTML = `${d.day}æ—¥<br>(${d.weekday})`;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                
                // å„ã‚¹ã‚¿ãƒƒãƒ•ã®è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«
                monthData.staff_list.forEach((staff, index) => {
                    const row = document.createElement('tr');
                    row.draggable = true;
                    row.dataset.staffIndex = index;
                    row.dataset.staffName = staff.name;
                    row.style.cursor = 'grab';
                    row.style.borderBottom = '1px solid #ddd';
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    row.addEventListener('dragstart', (e) => {
                        row.style.opacity = '0.5';
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('draggedRow', row.dataset.staffIndex);
                    });
                    
                    row.addEventListener('dragend', (e) => {
                        row.style.opacity = '1';
                        document.querySelectorAll('tr[draggable=true]').forEach(r => r.style.backgroundColor = '');
                    });
                    
                    row.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        row.style.backgroundColor = '#e8f4f8';
                    });
                    
                    row.addEventListener('dragleave', (e) => {
                        row.style.backgroundColor = '';
                    });
                    
                    row.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const draggedIndex = e.dataTransfer.getData('draggedRow');
                        const targetIndex = row.dataset.staffIndex;
                        if (draggedIndex !== targetIndex) {
                            swapTableRows(table, parseInt(draggedIndex), parseInt(targetIndex));
                            saveStaffOrder(monthData.month, table);
                        }
                        row.style.backgroundColor = '';
                    });
                    
                    const td1 = document.createElement('td');
                    td1.style.textAlign = 'left';
                    td1.innerHTML = `${staff.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤'} ${staff.name}`;
                    row.appendChild(td1);
                    
                    staff.shifts.forEach((shifts, dateIdx) => {
                        const td = document.createElement('td');
                        const display = shifts.join('<br>');
                        td.innerHTML = display || '-';
                        td.style.textAlign = 'center';
                        td.style.cursor = 'pointer';
                        td.style.padding = '5px';
                        td.dataset.staffName = staff.name;
                        td.dataset.dateStr = monthData.dates[dateIdx].date;
                        td.dataset.currentShifts = JSON.stringify(shifts);
                        
                        // ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
                        td.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showShiftEditMenu(td, monthData.dates[dateIdx]);
                        });
                        
                        // ãƒ›ãƒãƒ¼æ™‚ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                        td.addEventListener('mouseover', () => {
                            td.style.backgroundColor = '#fff3cd';
                        });
                        td.addEventListener('mouseout', () => {
                            td.style.backgroundColor = '';
                        });
                        
                        row.appendChild(td);
                    });
                    
                    table.appendChild(row);
                });
                
                monthGroup.appendChild(table);
                
                // æœˆã”ã¨ã®ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’åˆæœŸåŒ–
                if (!staffOrder[monthData.month]) {
                    saveStaffOrder(monthData.month, table);
                }
                
                // å¿…è¦äººæ•°ãƒã‚§ãƒƒã‚¯ï¼ˆå„æ—¥ä»˜ã”ã¨ï¼‰
                const checkDiv = document.createElement('div');
                checkDiv.style.marginTop = '15px';
                checkDiv.innerHTML = '<h4>å¿…è¦äººæ•°ãƒã‚§ãƒƒã‚¯</h4>';
                
                monthData.dates.forEach(async d => {
                    const checkResponse = await fetch('/api/check_requirements', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({date: d.date})
                    });
                    const checkData = await checkResponse.json();
                    
                    const dayCheck = document.createElement('div');
                    dayCheck.style.marginBottom = '10px';
                    dayCheck.innerHTML = `<strong>${d.day}æ—¥(${d.weekday})</strong>`;
                    
                    checkData.forEach(slot => {
                        const staffOk = slot.staff_ok ? 'âœ“' : 'âš ';
                        const parttimeOk = slot.parttime_ok ? 'âœ“' : 'âš ';
                        const item = document.createElement('div');
                        item.style.fontSize = '11px';
                        item.style.marginLeft = '10px';
                        item.innerHTML = `${slot.time_slot}: ç¤¾å“¡${staffOk}(${slot.assigned_staff}/${slot.required_staff}) ãƒã‚¤ãƒˆ${parttimeOk}(${slot.assigned_parttime}/${slot.required_parttime})`;
                        dayCheck.appendChild(item);
                    });
                    
                    checkDiv.appendChild(dayCheck);
                });
                
                monthGroup.appendChild(checkDiv);
                container.appendChild(monthGroup);
            });
        }
        
        function swapTableRows(table, index1, index2) {
            const rows = Array.from(table.querySelectorAll('tr[draggable=true]'));
            if (rows[index1] && rows[index2]) {
                const temp = rows[index1].cloneNode(true);
                rows[index1].replaceWith(rows[index2].cloneNode(true));
                rows[index2].replaceWith(temp);
                // æ–°ã—ã„è¡Œã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†åº¦è¨­å®š
                Array.from(table.querySelectorAll('tr[draggable=true]')).forEach((row, idx) => {
                    row.dataset.staffIndex = idx;
                    row.addEventListener('dragstart', handleDragStart);
                    row.addEventListener('dragend', handleDragEnd);
                    row.addEventListener('dragover', handleDragOver);
                    row.addEventListener('dragleave', handleDragLeave);
                    row.addEventListener('drop', handleDrop);
                });
            }
        }
        
        function handleDragStart(e) {
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('draggedRow', this.dataset.staffIndex);
        }
        
        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            document.querySelectorAll('tr[draggable=true]').forEach(r => r.style.backgroundColor = '');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            this.style.backgroundColor = '#e8f4f8';
        }
        
        function handleDragLeave(e) {
            this.style.backgroundColor = '';
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const draggedIndex = e.dataTransfer.getData('draggedRow');
            const targetIndex = this.dataset.staffIndex;
            if (draggedIndex !== targetIndex) {
                const table = this.closest('table');
                swapTableRows(table, parseInt(draggedIndex), parseInt(targetIndex));
                saveStaffOrder(table.dataset.month, table);
            }
            this.style.backgroundColor = '';
        }
        
        function saveStaffOrder(month, table) {
            const order = [];
            table.querySelectorAll('tr[draggable=true]').forEach(row => {
                order.push(row.dataset.staffName);
            });
            staffOrder[month] = order;
        }
        
        function getStaffOrder(month) {
            return staffOrder[month] || null;
        }
        
        // ã‚·ãƒ•ãƒˆç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showShiftEditMenu(td, dateInfo) {
            const staffName = td.dataset.staffName;
            const dateStr = td.dataset.dateStr;
            const currentShifts = JSON.parse(td.dataset.currentShifts);
            
            // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
            const existingMenu = document.getElementById('shiftEditMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¦ç´ ã‚’ä½œæˆ
            const menu = document.createElement('div');
            menu.id = 'shiftEditMenu';
            menu.style.position = 'fixed';
            menu.style.top = event.clientY + 'px';
            menu.style.left = event.clientX + 'px';
            menu.style.backgroundColor = 'white';
            menu.style.border = '1px solid #ccc';
            menu.style.borderRadius = '4px';
            menu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            menu.style.zIndex = '10000';
            menu.style.minWidth = '150px';
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ
            const options = ['ã‚·ãƒ•ãƒˆãªã—', '10-15', '17-23', '18-23', '19-23'];
            
            options.forEach(opt => {
                const item = document.createElement('div');
                item.style.padding = '8px 12px';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid #eee';
                
                const displayName = opt === 'ã‚·ãƒ•ãƒˆãªã—' ? '-' : opt;
                const isSelected = opt === 'ã‚·ãƒ•ãƒˆãªã—' ? currentShifts.length === 0 : currentShifts.includes(opt);
                
                item.innerHTML = isSelected ? `âœ“ ${displayName}` : displayName;
                item.style.backgroundColor = isSelected ? '#e8f4f8' : 'white';
                
                item.addEventListener('mouseover', () => {
                    item.style.backgroundColor = '#f0f0f0';
                });
                item.addEventListener('mouseout', () => {
                    item.style.backgroundColor = isSelected ? '#e8f4f8' : 'white';
                });
                
                item.addEventListener('click', async () => {
                    // ã‚·ãƒ•ãƒˆã‚’æ›´æ–°
                    const newShifts = opt === 'ã‚·ãƒ•ãƒˆãªã—' ? [] : [opt];
                    await updateShift(staffName, dateStr, newShifts);
                    menu.remove();
                });
                
                menu.appendChild(item);
            });
            
            document.body.appendChild(menu);
            
            // å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‰ã˜ã‚‹
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }
        
        // ã‚·ãƒ•ãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¦æ›´æ–°
        async function updateShift(staffName, dateStr, newShifts) {
            try {
                console.log('Updating shift:', {staffName, dateStr, newShifts});
                
                const response = await fetch('/api/update-shift', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        staff_name: staffName,
                        date: dateStr,
                        shifts: newShifts
                    })
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response body:', result);
                
                if (response.ok) {
                    if (result.success) {
                        console.log('Update successful, regenerating shift...');
                        // è¡¨ã‚’å†ç”Ÿæˆã—ã¦åæ˜ 
                        await generateShift();
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                    }
                } else {
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + response.status);
                }
            } catch (error) {
                console.error('Error updating shift:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function exportCSV() {
            // ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
            const orderData = JSON.stringify(staffOrder);
            window.location.href = `/api/export/csv?order=${encodeURIComponent(orderData)}`;
        }

        // æœˆåˆ‡ã‚Šæ›¿ãˆ
        function changeMonth(delta, type) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            if (type === 'shifts') {
                loadShiftTable();
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            loadStaff();
            
            // ãƒœã‚¿ãƒ³ã®å‹•ä½œç¢ºèª
            const staffNameInput = document.getElementById('staffName');
            const staffTypeSelect = document.getElementById('staffType');
            const addStaffBtn = document.getElementById('addStaffBtn');
            
            if (staffNameInput) {
                console.log('staffName input found');
            } else {
                console.error('staffName input NOT found');
            }
            if (staffTypeSelect) {
                console.log('staffType select found');
            } else {
                console.error('staffType select NOT found');
            }
            if (addStaffBtn) {
                console.log('addStaffBtn button found');
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚‚ç™»éŒ²
                addStaffBtn.addEventListener('click', function(e) {
                    console.log('Button clicked via event listener');
                    e.preventDefault();
                    addStaff();
                });
            } else {
                console.error('addStaffBtn button NOT found');
            }
            
            // Enterã‚­ãƒ¼ã§ã‚‚è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            if (staffNameInput) {
                staffNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('Enter key pressed');
                        addStaff();
                    }
                });
            }
            
            // æ™‚é–“å¸¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®Enterã‚­ãƒ¼å¯¾å¿œ
            const newTimeSlotInput = document.getElementById('newTimeSlot');
            if (newTimeSlotInput) {
                newTimeSlotInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTimeSlot();
                    }
                });
            }
        });

        // ========== ã‚·ãƒ•ãƒˆè©³ç´°è¨­å®šé–¢é€£ ==========
        
        let currentTimeSlots = [];

        async function loadShiftSettings() {
            try {
                const response = await fetch('/api/shift-settings');
                const data = await response.json();
                
                if (data.success) {
                    currentTimeSlots = data.time_slots || ['10-15', '17-23', '18-23', '19-23'];
                    displayTimeSlots(currentTimeSlots);
                    displayShiftSettings(data.settings, currentTimeSlots);
                }
            } catch (error) {
                console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function displayTimeSlots(timeSlots) {
            const container = document.getElementById('timeSlotsList');
            container.innerHTML = '';
            
            timeSlots.forEach(slot => {
                const tag = document.createElement('div');
                tag.className = 'time-slot-tag';
                tag.innerHTML = `
                    <span>${slot}</span>
                    <button class="remove-btn" onclick="removeTimeSlot('${slot}')" title="å‰Šé™¤">Ã—</button>
                `;
                container.appendChild(tag);
            });
        }

        async function addTimeSlot() {
            const input = document.getElementById('newTimeSlot');
            const newSlot = input.value.trim();
            
            if (!newSlot) {
                alert('æ™‚é–“å¸¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼š10-15ï¼‰
            if (!/^\d{1,2}-\d{1,2}$/.test(newSlot)) {
                alert('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œé–‹å§‹æ™‚-çµ‚äº†æ™‚ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š10-15ï¼‰');
                return;
            }
            
            if (currentTimeSlots.includes(newSlot)) {
                alert('ã“ã®æ™‚é–“å¸¯ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            currentTimeSlots.push(newSlot);
            
            try {
                const response = await fetch('/api/time-slots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_slots: currentTimeSlots})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    input.value = '';
                    loadShiftSettings(); // å†èª­ã¿è¾¼ã¿
                    alert('âœ… æ™‚é–“å¸¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                } else {
                    alert('âŒ è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                    currentTimeSlots.pop(); // å¤±æ•—ã—ãŸã‚‰æˆ»ã™
                }
            } catch (error) {
                console.error('æ™‚é–“å¸¯è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                currentTimeSlots.pop();
            }
        }

        async function removeTimeSlot(slot) {
            if (!confirm(`æ™‚é–“å¸¯ã€Œ${slot}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» ã“ã®æ™‚é–“å¸¯ã«é–¢é€£ã™ã‚‹ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚å½±éŸ¿ã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`)) {
                return;
            }
            
            currentTimeSlots = currentTimeSlots.filter(s => s !== slot);
            
            try {
                const response = await fetch('/api/time-slots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_slots: currentTimeSlots})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadShiftSettings(); // å†èª­ã¿è¾¼ã¿
                    alert('âœ… æ™‚é–“å¸¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                    currentTimeSlots.push(slot); // å¤±æ•—ã—ãŸã‚‰æˆ»ã™
                }
            } catch (error) {
                console.error('æ™‚é–“å¸¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                currentTimeSlots.push(slot);
            }
        }

        function displayShiftSettings(settings, timeSlots) {
            if (!timeSlots) {
                timeSlots = ['10-15', '17-23', '18-23', '19-23'];
            }
            
            // å¹³æ—¥è¨­å®šã‚’è¡¨ç¤º
            const weekdayTbody = document.getElementById('weekdaySettings');
            weekdayTbody.innerHTML = '';
            timeSlots.forEach(slot => {
                const config = settings.weekday[slot] || {staff: 1, parttime: 0};
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${slot}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                        <input type="number" min="0" max="10" value="${config.staff}" 
                               data-day="weekday" data-slot="${slot}" data-type="staff"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                        <input type="number" min="0" max="10" value="${config.parttime}" 
                               data-day="weekday" data-slot="${slot}" data-type="parttime"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                `;
                weekdayTbody.appendChild(row);
            });
            
            // é€±æœ«è¨­å®šã‚’è¡¨ç¤º
            const weekendTbody = document.getElementById('weekendSettings');
            weekendTbody.innerHTML = '';
            timeSlots.forEach(slot => {
                const config = settings.weekend[slot] || {staff: 1, parttime: 0};
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${slot}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                        <input type="number" min="0" max="10" value="${config.staff}" 
                               data-day="weekend" data-slot="${slot}" data-type="staff"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                        <input type="number" min="0" max="10" value="${config.parttime}" 
                               data-day="weekend" data-slot="${slot}" data-type="parttime"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                `;
                weekendTbody.appendChild(row);
            });
        }

        async function saveShiftSettings() {
            try {
                // å…¥åŠ›å€¤ã‹ã‚‰è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                const settings = {
                    weekday: {},
                    weekend: {}
                };
                
                // ç¾åœ¨ã®æ™‚é–“å¸¯ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
                const timeSlots = currentTimeSlots;
                
                // å¹³æ—¥è¨­å®š
                timeSlots.forEach(slot => {
                    const staffInput = document.querySelector(`input[data-day="weekday"][data-slot="${slot}"][data-type="staff"]`);
                    const parttimeInput = document.querySelector(`input[data-day="weekday"][data-slot="${slot}"][data-type="parttime"]`);
                    if (staffInput && parttimeInput) {
                        settings.weekday[slot] = {
                            staff: parseInt(staffInput.value) || 0,
                            parttime: parseInt(parttimeInput.value) || 0
                        };
                    }
                });
                
                // é€±æœ«è¨­å®š
                timeSlots.forEach(slot => {
                    const staffInput = document.querySelector(`input[data-day="weekend"][data-slot="${slot}"][data-type="staff"]`);
                    const parttimeInput = document.querySelector(`input[data-day="weekend"][data-slot="${slot}"][data-type="parttime"]`);
                    if (staffInput && parttimeInput) {
                        settings.weekend[slot] = {
                            staff: parseInt(staffInput.value) || 0,
                            parttime: parseInt(parttimeInput.value) || 0
                        };
                    }
                });
                
                const response = await fetch('/api/shift-settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({settings: settings})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } else {
                    alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                }
            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function resetShiftSettings() {
            if (!confirm('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            // ç¾åœ¨ã®æ™‚é–“å¸¯ã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ç”Ÿæˆ
            const defaultSettings = {
                weekday: {},
                weekend: {}
            };
            
            currentTimeSlots.forEach(slot => {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
                defaultSettings.weekday[slot] = {staff: 1, parttime: 1};
                defaultSettings.weekend[slot] = {staff: 1, parttime: 1};
            });
            
            displayShiftSettings(defaultSettings, currentTimeSlots);
            alert('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
        }

        // ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´é–¢é€£ ==========

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!currentPassword) {
                alert('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!newPassword) {
                alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (newPassword.length < 4) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                return;
            }

            if (currentPassword === newPassword) {
                alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç•°ãªã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\nå¤‰æ›´å¾Œã¯æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚')) {
                return;
            }

            try {
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼\næ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚');
                    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || ''));
                }
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

    </script>
</body>
</html>
