<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            padding-bottom: 60px;
        }

        .header {
            background-color: #2196F3;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
        }

        .tabs {
            display: flex;
            background-color: white;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: white;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid #2196F3;
            color: #2196F3;
            font-weight: bold;
        }

        .content {
            display: none;
            padding: 15px;
        }

        .content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .staff-list {
            list-style: none;
        }

        .staff-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .staff-item:last-child {
            border-bottom: none;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-nav button {
            padding: 8px 15px;
            border: 1px solid #2196F3;
            background: white;
            color: #2196F3;
            border-radius: 4px;
            cursor: pointer;
        }

        .month-nav h3 {
            font-size: 18px;
        }

        .shift-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }

        th {
            background-color: #2196F3;
            color: white;
            position: sticky;
            top: 0;
        }

        td.staff-name {
            font-weight: 500;
            background-color: #f9f9f9;
            text-align: left;
            position: sticky;
            left: 0;
        }

        td.clickable {
            cursor: pointer;
            min-width: 60px;
        }

        td.clickable:hover {
            background-color: #e3f2fd;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h3 {
            margin-bottom: 15px;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-group label {
            display: block;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .checkbox-group label:has(input:checked) {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }
        
        .change-option {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            border: 1px solid #ffc107;
        }
        
        .change-option h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #856404;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .shift-result {
            max-height: 60vh;
            overflow-y: auto;
        }

        .date-group {
            margin-bottom: 20px;
        }

        .date-group h3 {
            background-color: #2196F3;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .shift-item {
            padding: 8px;
            border-left: 3px solid #4CAF50;
            background-color: #f9f9f9;
            margin-bottom: 5px;
            padding-left: 10px;
        }

        .requirement-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            padding-left: 10px;
        }

        .requirement-item.satisfied {
            background-color: #d4edda;
            border-left-color: #28a745;
        }

        .requirement-item.unsatisfied {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

        @media (max-width: 600px) {
            .tabs {
                font-size: 12px;
            }
            
            .tab {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“… ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</h1>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('staff', event)">ã‚¹ã‚¿ãƒƒãƒ•</button>
        <button class="tab" onclick="showTab('shifts', event)">ã‚·ãƒ•ãƒˆå¸Œæœ›</button>
        <button class="tab" onclick="showTab('generate', event)">ã‚·ãƒ•ãƒˆè¡¨</button>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã‚¿ãƒ– -->
    <div id="staff" class="content active">
        <div class="card">
            <h2>ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h2>
            <div class="form-group">
                <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                <input type="text" id="staffName" placeholder="åå‰ã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label>ç¨®åˆ¥</label>
                <select id="staffType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                    <option value="ã‚¢ãƒ«ãƒã‚¤ãƒˆ">ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
                    <option value="ç¤¾å“¡">ç¤¾å“¡</option>
                </select>
            </div>
            <button type="button" class="btn btn-primary" id="addStaffBtn" onclick="console.log('Button clicked!'); addStaff();">è¿½åŠ </button>
        </div>

        <div class="card">
            <h2>ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•</h2>
            <ul class="staff-list" id="staffList"></ul>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›ã‚¿ãƒ– -->
    <div id="shifts" class="content">
        <div class="card">
            <div class="month-nav">
                <button onclick="changeMonth(-1, 'shifts')">â—€ å‰æœˆ</button>
                <h3 id="shiftMonth"></h3>
                <button onclick="changeMonth(1, 'shifts')">æ¬¡æœˆ â–¶</button>
            </div>
            <div class="shift-table">
                <table id="shiftTable"></table>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆã‚¿ãƒ– -->
    <div id="generate" class="content">
        <div class="card">
            <h2>ã‚·ãƒ•ãƒˆç”Ÿæˆ</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                â€»ã‚·ãƒ•ãƒˆã¯è‡ªå‹•çš„ã«æœ€é©åŒ–ã•ã‚Œã¾ã™ã€‚å¿…è¦äººæ•°ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã€é©æ­£äººæ•°ã¾ã§èª¿æ•´ã•ã‚Œã¾ã™ã€‚
            </p>
            <button class="btn btn-success" onclick="generateShift()">ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆ</button>
            <button class="btn btn-primary" onclick="exportCSV()" style="margin-top: 10px;">PDFå‡ºåŠ›</button>
        </div>
        <div class="card">
            <h2>ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ•ãƒˆ</h2>
            <div class="shift-result" id="shiftResult"></div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›ï¼‰ -->
    <div id="shiftModal" class="modal">
        <div class="modal-content">
            <h3>ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</h3>
            <p id="modalInfo"></p>
            <div class="checkbox-group" id="timeSlotCheckboxes"></div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveShift()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let currentStaff = [];
        let timeSlots = [];
        let changeMap = {};  // æ™‚é–“å¸¯å¤‰æ›´ãƒãƒƒãƒ—
        let modalData = {};

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'staff') {
                loadStaff();
            } else if (tabName === 'shifts') {
                loadShiftTable();
            }
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
        async function loadStaff() {
            try {
                const response = await fetch('/api/staff');
                const staffData = await response.json();
                currentStaff = staffData;
                
                const list = document.getElementById('staffList');
                list.innerHTML = '';
                
                if (Object.keys(currentStaff).length === 0) {
                    list.innerHTML = '<li class="staff-item">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</li>';
                    return;
                }
            
                Object.entries(currentStaff).sort().forEach(([name, info]) => {
                    const li = document.createElement('li');
                    li.className = 'staff-item';
                    const badge = info.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤';
                    li.innerHTML = `
                        <span>${badge} ${name} (${info.type})</span>
                        <button class="btn btn-danger" style="width: auto; padding: 8px 15px;" onclick="deleteStaff('${name}')">å‰Šé™¤</button>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Error in loadStaff:', error);
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function addStaff() {
            try {
                console.log('addStaff function called');
                const name = document.getElementById('staffName').value.trim();
                const type = document.getElementById('staffType').value;
                console.log('Name:', name, 'Type:', type);
                
                if (!name) {
                    alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const response = await fetch('/api/staff', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, type})
                });

                const result = await response.json();
                console.log('Response:', result);
                
                if (response.ok) {
                    document.getElementById('staffName').value = '';
                    loadStaff();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                console.error('Error in addStaff:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteStaff(name) {
            try {
                if (!confirm(`${name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

                const response = await fetch(`/api/staff/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadStaff();
                } else {
                    const result = await response.json();
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Error in deleteStaff:', error);
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›
        async function loadShiftTable() {
            const response = await fetch(`/api/shifts/${currentYear}/${currentMonth}`);
            const data = await response.json();
            
            currentStaff = data.staff;
            timeSlots = data.time_slots;
            
            document.getElementById('shiftMonth').textContent = `${currentYear}å¹´${currentMonth}æœˆ`;
            
            const table = document.getElementById('shiftTable');
            table.innerHTML = '';
            
            if (Object.keys(currentStaff).length === 0) {
                table.innerHTML = '<tr><td colspan="100%">ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</td></tr>';
                return;
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            let headerRow = '<tr><th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            for (let day = 1; day <= data.days_in_month; day++) {
                const dayOfWeek = new Date(currentYear, currentMonth - 1, day).getDay();
                const weekday = weekdays[dayOfWeek];
                headerRow += `<th>${day}æ—¥<br>(${weekday})</th>`;
            }
            headerRow += '</tr>';
            table.innerHTML = headerRow;
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            Object.entries(currentStaff).sort().forEach(([staffName, staffInfo]) => {
                const badge = staffInfo.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤';
                let row = `<tr><td class="staff-name">${badge} ${staffName}</td>`;
                for (let day = 1; day <= data.days_in_month; day++) {
                    const date = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const slots = data.shifts[date]?.[staffName] || [];
                    const display = slots.join(', ');
                    
                    row += `<td class="clickable" onclick="openShiftModal('${date}', '${staffName}')">${display}</td>`;
                }
                row += '</tr>';
                table.innerHTML += row;
            });
        }

        function openShiftModal(date, staff) {
            modalData = {date, staff};
            
            document.getElementById('modalInfo').textContent = `${date} - ${staff}`;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            const container = document.getElementById('timeSlotCheckboxes');
            container.innerHTML = '';
            
            // ç¾åœ¨ã®é¸æŠã‚’å–å¾—
            fetch(`/api/shifts/${currentYear}/${currentMonth}`)
                .then(res => res.json())
                .then(data => {
                    const currentSlots = data.shifts[date]?.[staff] || [];
                    changeMap = data.change_map || {};
                    
                    // ã‚¹ã‚¿ãƒƒãƒ•ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
                    const staffType = currentStaff[staff]?.type || 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';
                    
                    if (staffType === 'ç¤¾å“¡') {
                        // ç¤¾å“¡ã®å ´åˆã¯ã€Œå‡ºå‹¤ã€ã®ã¿è¡¨ç¤º
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = 'work';
                        checkbox.checked = currentSlots.length > 0;
                        checkbox.id = 'workCheckbox';
                        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' å‡ºå‹¤'));
                        
                        const note = document.createElement('div');
                        note.style.fontSize = '12px';
                        note.style.color = '#666';
                        note.style.marginTop = '10px';
                        note.textContent = 'â€»ç¤¾å“¡ã¯é€šã—å‹¤å‹™ï¼ˆãƒ©ãƒ³ãƒï¼‹ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰ã§ã™';
                        
                        container.appendChild(label);
                        container.appendChild(note);
                    } else {
                        // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆã¯æ™‚é–“å¸¯ã‚’è¡¨ç¤º
                        timeSlots.forEach(slot => {
                            const label = document.createElement('label');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = slot;
                            checkbox.checked = currentSlots.includes(slot);
                            
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(` ${slot}`));
                            
                            container.appendChild(label);
                        });
                    
                    // å¤‰æ›´ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆã‚¢ãƒ«ãƒã‚¤ãƒˆã®ã¿ï¼‰
                    if (staffType === 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ' && currentSlots.length > 0) {
                        const changeDiv = document.createElement('div');
                        changeDiv.className = 'change-option';
                        changeDiv.innerHTML = '<h4>âš™ï¸ æ™‚é–“å¸¯ã‚’å¤‰æ›´</h4>';
                        
                        currentSlots.forEach(slot => {
                            if (changeMap[slot] && changeMap[slot].length > 0) {
                                const optionDiv = document.createElement('div');
                                optionDiv.style.marginBottom = '10px';
                                optionDiv.innerHTML = `<strong>${slot}</strong> â†’ `;
                                
                                changeMap[slot].forEach(targetSlot => {
                                    const btn = document.createElement('button');
                                    btn.textContent = targetSlot;
                                    btn.className = 'btn';
                                    btn.style.width = 'auto';
                                    btn.style.padding = '5px 10px';
                                    btn.style.marginLeft = '5px';
                                    btn.style.fontSize = '12px';
                                    btn.onclick = () => changeTimeSlot(slot, targetSlot);
                                    optionDiv.appendChild(btn);
                                });
                                
                                changeDiv.appendChild(optionDiv);
                            }
                        });
                        
                        container.appendChild(changeDiv);
                    }
                    }
                    
                    document.getElementById('shiftModal').classList.add('active');
                });
        }
        
        function changeTimeSlot(fromSlot, toSlot) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¤‰æ›´
            const checkboxes = document.querySelectorAll('#timeSlotCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.value === fromSlot) {
                    cb.checked = false;
                } else if (cb.value === toSlot) {
                    cb.checked = true;
                }
            });
            
            alert(`${fromSlot} ã‚’ ${toSlot} ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚`);
        }

        async function saveShift() {
            const staffType = currentStaff[modalData.staff]?.type || 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ';
            let selectedSlots;
            
            if (staffType === 'ç¤¾å“¡') {
                // ç¤¾å“¡ã®å ´åˆã€å‡ºå‹¤ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚Œã°å…¨æ™‚é–“å¸¯ã‚’è¨­å®š
                const workCheckbox = document.getElementById('workCheckbox');
                if (workCheckbox && workCheckbox.checked) {
                    selectedSlots = ['10-15', '17-23'];
                } else {
                    selectedSlots = [];
                }
            } else {
                // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ™‚é–“å¸¯ã‚’å–å¾—
                const checkboxes = document.querySelectorAll('#timeSlotCheckboxes input[type="checkbox"]:checked');
                selectedSlots = Array.from(checkboxes).map(cb => cb.value);
            }
            
            const response = await fetch('/api/shifts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    date: modalData.date,
                    staff: modalData.staff,
                    time_slots: selectedSlots
                })
            });
            
            if (response.ok) {
                closeModal();
                loadShiftTable();
            }
        }

        // ã‚·ãƒ•ãƒˆç”Ÿæˆ
        let staffOrder = {};  // æœˆã”ã¨ã®ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’ä¿å­˜

        async function generateShift() {
            const response = await fetch('/api/generate');
            const months = await response.json();
            
            const container = document.getElementById('shiftResult');
            container.innerHTML = '';
            
            if (months.length === 0) {
                container.innerHTML = '<p>ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            months.forEach(monthData => {
                const monthGroup = document.createElement('div');
                monthGroup.className = 'date-group';
                
                // æœˆè¦‹å‡ºã—
                const monthHeader = document.createElement('h3');
                monthHeader.textContent = monthData.month;
                monthGroup.appendChild(monthHeader);
                
                // è¡Œé †åºèª¿æ•´ãƒ‘ãƒãƒ«
                const controlDiv = document.createElement('div');
                controlDiv.style.marginBottom = '10px';
                controlDiv.style.padding = '10px';
                controlDiv.style.backgroundColor = '#f5f5f5';
                controlDiv.style.borderRadius = '5px';
                controlDiv.innerHTML = '<small style="color: #666;">ğŸ’¡ è¡¨ã®è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</small>';
                monthGroup.appendChild(controlDiv);
                
                // è¡¨ã‚’ä½œæˆ
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.fontSize = '12px';
                table.className = 'draggable-table';
                table.dataset.month = monthData.month;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆæ—¥ä»˜ã¨æ›œæ—¥ï¼‰
                const headerRow = document.createElement('tr');
                headerRow.style.backgroundColor = '#f9f9f9';
                const th1 = document.createElement('th');
                th1.textContent = 'åå‰';
                headerRow.appendChild(th1);
                monthData.dates.forEach(d => {
                    const th = document.createElement('th');
                    th.innerHTML = `${d.day}æ—¥<br>(${d.weekday})`;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                
                // å„ã‚¹ã‚¿ãƒƒãƒ•ã®è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«
                monthData.staff_list.forEach((staff, index) => {
                    const row = document.createElement('tr');
                    row.draggable = true;
                    row.dataset.staffIndex = index;
                    row.dataset.staffName = staff.name;
                    row.style.cursor = 'grab';
                    row.style.borderBottom = '1px solid #ddd';
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    row.addEventListener('dragstart', (e) => {
                        row.style.opacity = '0.5';
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('draggedRow', row.dataset.staffIndex);
                    });
                    
                    row.addEventListener('dragend', (e) => {
                        row.style.opacity = '1';
                        document.querySelectorAll('tr[draggable=true]').forEach(r => r.style.backgroundColor = '');
                    });
                    
                    row.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        row.style.backgroundColor = '#e8f4f8';
                    });
                    
                    row.addEventListener('dragleave', (e) => {
                        row.style.backgroundColor = '';
                    });
                    
                    row.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const draggedIndex = e.dataTransfer.getData('draggedRow');
                        const targetIndex = row.dataset.staffIndex;
                        if (draggedIndex !== targetIndex) {
                            swapTableRows(table, parseInt(draggedIndex), parseInt(targetIndex));
                            saveStaffOrder(monthData.month, table);
                        }
                        row.style.backgroundColor = '';
                    });
                    
                    const td1 = document.createElement('td');
                    td1.style.textAlign = 'left';
                    td1.innerHTML = `${staff.type === 'ç¤¾å“¡' ? 'ğŸ‘”' : 'ğŸ‘¤'} ${staff.name}`;
                    row.appendChild(td1);
                    
                    staff.shifts.forEach(shifts => {
                        const td = document.createElement('td');
                        const display = shifts.join('<br>');
                        td.textContent = display || '-';
                        td.style.textAlign = 'center';
                        row.appendChild(td);
                    });
                    
                    table.appendChild(row);
                });
                
                monthGroup.appendChild(table);
                
                // æœˆã”ã¨ã®ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’åˆæœŸåŒ–
                if (!staffOrder[monthData.month]) {
                    saveStaffOrder(monthData.month, table);
                }
                
                // å¿…è¦äººæ•°ãƒã‚§ãƒƒã‚¯ï¼ˆå„æ—¥ä»˜ã”ã¨ï¼‰
                const checkDiv = document.createElement('div');
                checkDiv.style.marginTop = '15px';
                checkDiv.innerHTML = '<h4>å¿…è¦äººæ•°ãƒã‚§ãƒƒã‚¯</h4>';
                
                monthData.dates.forEach(async d => {
                    const checkResponse = await fetch('/api/check_requirements', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({date: d.date})
                    });
                    const checkData = await checkResponse.json();
                    
                    const dayCheck = document.createElement('div');
                    dayCheck.style.marginBottom = '10px';
                    dayCheck.innerHTML = `<strong>${d.day}æ—¥(${d.weekday})</strong>`;
                    
                    checkData.forEach(slot => {
                        const staffOk = slot.staff_ok ? 'âœ“' : 'âš ';
                        const parttimeOk = slot.parttime_ok ? 'âœ“' : 'âš ';
                        const item = document.createElement('div');
                        item.style.fontSize = '11px';
                        item.style.marginLeft = '10px';
                        item.innerHTML = `${slot.time_slot}: ç¤¾å“¡${staffOk}(${slot.assigned_staff}/${slot.required_staff}) ãƒã‚¤ãƒˆ${parttimeOk}(${slot.assigned_parttime}/${slot.required_parttime})`;
                        dayCheck.appendChild(item);
                    });
                    
                    checkDiv.appendChild(dayCheck);
                });
                
                monthGroup.appendChild(checkDiv);
                container.appendChild(monthGroup);
            });
        }
        
        function swapTableRows(table, index1, index2) {
            const rows = Array.from(table.querySelectorAll('tr[draggable=true]'));
            if (rows[index1] && rows[index2]) {
                const temp = rows[index1].cloneNode(true);
                rows[index1].replaceWith(rows[index2].cloneNode(true));
                rows[index2].replaceWith(temp);
                // æ–°ã—ã„è¡Œã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†åº¦è¨­å®š
                Array.from(table.querySelectorAll('tr[draggable=true]')).forEach((row, idx) => {
                    row.dataset.staffIndex = idx;
                    row.addEventListener('dragstart', handleDragStart);
                    row.addEventListener('dragend', handleDragEnd);
                    row.addEventListener('dragover', handleDragOver);
                    row.addEventListener('dragleave', handleDragLeave);
                    row.addEventListener('drop', handleDrop);
                });
            }
        }
        
        function handleDragStart(e) {
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('draggedRow', this.dataset.staffIndex);
        }
        
        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            document.querySelectorAll('tr[draggable=true]').forEach(r => r.style.backgroundColor = '');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            this.style.backgroundColor = '#e8f4f8';
        }
        
        function handleDragLeave(e) {
            this.style.backgroundColor = '';
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const draggedIndex = e.dataTransfer.getData('draggedRow');
            const targetIndex = this.dataset.staffIndex;
            if (draggedIndex !== targetIndex) {
                const table = this.closest('table');
                swapTableRows(table, parseInt(draggedIndex), parseInt(targetIndex));
                saveStaffOrder(table.dataset.month, table);
            }
            this.style.backgroundColor = '';
        }
        
        function saveStaffOrder(month, table) {
            const order = [];
            table.querySelectorAll('tr[draggable=true]').forEach(row => {
                order.push(row.dataset.staffName);
            });
            staffOrder[month] = order;
        }
        
        function getStaffOrder(month) {
            return staffOrder[month] || null;
        }

        function exportCSV() {
            // ã‚¹ã‚¿ãƒƒãƒ•é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
            const orderData = JSON.stringify(staffOrder);
            window.location.href = `/api/export/csv?order=${encodeURIComponent(orderData)}`;
        }

        // æœˆåˆ‡ã‚Šæ›¿ãˆ
        function changeMonth(delta, type) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            if (type === 'shifts') {
                loadShiftTable();
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            loadStaff();
            
            // ãƒœã‚¿ãƒ³ã®å‹•ä½œç¢ºèª
            const staffNameInput = document.getElementById('staffName');
            const staffTypeSelect = document.getElementById('staffType');
            const addStaffBtn = document.getElementById('addStaffBtn');
            
            if (staffNameInput) {
                console.log('staffName input found');
            } else {
                console.error('staffName input NOT found');
            }
            if (staffTypeSelect) {
                console.log('staffType select found');
            } else {
                console.error('staffType select NOT found');
            }
            if (addStaffBtn) {
                console.log('addStaffBtn button found');
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚‚ç™»éŒ²
                addStaffBtn.addEventListener('click', function(e) {
                    console.log('Button clicked via event listener');
                    e.preventDefault();
                    addStaff();
                });
            } else {
                console.error('addStaffBtn button NOT found');
            }
            
            // Enterã‚­ãƒ¼ã§ã‚‚è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            if (staffNameInput) {
                staffNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('Enter key pressed');
                        addStaff();
                    }
                });
            }
        });
    </script>
</body>
</html>
